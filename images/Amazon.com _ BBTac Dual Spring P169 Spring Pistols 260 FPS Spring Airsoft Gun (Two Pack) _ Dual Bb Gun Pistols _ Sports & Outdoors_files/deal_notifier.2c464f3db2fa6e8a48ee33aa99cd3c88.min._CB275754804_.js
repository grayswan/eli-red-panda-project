if(typeof JSON!=="object"){JSON={}}(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==="string"){k=rep[i];v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}());
if(!window.GBResources){(function(){var a=function(f,d){var c=f;if(d===undefined){for(var b in d){c[b]=d[b]}}var e=(c&&c.__init__)||function(){};e.prototype=c;return e};window.GBResources=new a({__init__:function(c){var b=this;b.strings={};b.images={};b.features={};b.customerData={};b.categories=[];b.dealDebug=false;b.loadedUrls={};b.preload_img_div=null;b.amznMerchantID=null;b.nodeIdToCategoryMap={};b.registered={};if(c==null){return}if(c.strings){b.registerStrings(c.strings)}if(c.images){b.registerImages(c.images)}if(c.preloadImageList){b.preloadImages(c.preloadImageList)}if(c.features){b.registerFeatures(c.features)}},registerStrings:function(b){var c=this;c.registerResources(c.strings,b)},getString:function(f,d){var b=this;if(!(f in b.strings)){b.log('!!! ERROR: StringId "'+f+'" does not exist in the strings repository.');return""}var g=""+b.strings[f];if(d==null){return g}for(var c in d){var e=new RegExp("\\${"+c+"}","g");g=g.replace(e,d[c])}return g},registerImages:function(c){var b=this;b.registerResources(b.images,c)},preloadImages:function(d){var b=this;if(d===null||d===undefined){return}for(var c=0;c<d.length;++c){if(b.images[d[c]]){b.preloadImage(b.images[d[c]])}}},preloadImage:function(c){var b=this;if(!b.preload_img_div){b.preload_img_div=b.div({style:"display:none"})}b.preload_img_div.appendChild(b.img({src:c}))},getImage:function(c){var b=this;return b.images[c]},registerFeatures:function(c){var b=this;b.registerResources(b.features,c)},getFeature:function(c){var b=this;return b.features[c]},registerCustomerData:function(b){var c=this;c.registerResources(c.customerData,b)},getCustomerData:function(c){var b=this;return b.customerData[c]},registerCategories:function(c){var b=this;b.registerResources(b.categories,c);b.registerNodeIdToCategoryMap()},getAllCategories:function(){var b=this;return b.categories},registerNodeIdToCategoryMap:function(){var d=this;for(var c=0;c<d.categories.length;c++){var b=d.categories[c];var f=b.nodeId;var e=b.category;d.nodeIdToCategoryMap[f]=e}},getNodeIdToCategoryMap:function(){var b=this;return b.nodeIdToCategoryMap},registerResources:function(d,b){var c=this;if(b===null||d===null){return}for(var e in b){d[e]=b[e]}},setDealDebug:function(c){var b=this;b.dealDebug=c},getDealDebug:function(){var b=this;return b.dealDebug},registerFromJSON:function(b){var c=this;if(b.GBStrings){c.registerStrings(b.GBStrings)}if(b.GBImages){c.registerImages(b.GBImages)}if(b.GBWeblabs){c.registerFeatures(b.GBWeblabs)}if(b.GBCustomerData){c.registerCustomerData(b.GBCustomerData)}if(b.GBWidgetName){c.registerFeatures(b.GBWidgetName)}if(b.GBZone){c.registerFeatures(b.GBZone)}if(b.GBCategories){c.registerCategories(b.GBCategories)}if(b.GBDealDebug){c.setDealDebug(b.GBDealDebug)}},setAmznMerchantID:function(c){var b=this;b.amznMerchantID=c},getAmznMerchantID:function(){var b=this;return b.amznMerchantID},isAmznMerchant:function(d,c){var b=this;if(d!==undefined&&d!==null){if(d==b.getAmznMerchantID()){return true}}else{if(c!==undefined&&c!==null){c=c.toLowerCase();if(c.indexOf("amazon")!=-1){return true}}}return false},img:function(c){var b=this;c=c||{};c.border=c.border||0;return b.el("img",c)},div:function(c,d){var b=this;return b.el("div",c,d)},el:function(f,c,d){var b=this;var e=document.createElement(f);if(c){b.set_attributes(e,c)}if(d){b.appendChildren(e,d)}return e},set_attributes:function(e,c){for(var b in c){if(b=="style"){e.style.cssText=c[b]}else{var d={"class":"className",checked:"defaultChecked",usemap:"useMap","for":"htmlFor",readonly:"readOnly",colspan:"colSpan",bgcolor:"bgColor",cellspacing:"cellSpacing",cellpadding:"cellPadding",valign:"vAlign",nowrap:"noWrap"}[b]||b;e[d]=c[b]}}},log:function(c){var b=this;c=new Date()+": "+c;if(window.console){window.console.log(c)}},loadJS:function(c,e){var b=this;if(c===undefined||c===null){b.log("GBResources::loadJS - Specified an undefined url");return}if(b.loadedUrls[c]){b.log("GBResources::loadJS - "+c+" is already loaded");return}b.loadedUrls[c]=true;var d=document.createElement("script");d.type="text/javascript";d.src=c;d.async=e?false:true;document.getElementsByTagName("head")[0].appendChild(d)},loadCSS:function(c){var b=this;if(c===undefined||c===null){b.log("GBResources::loadCSS - Specified an undefined url");return}if(b.loadedUrls[c]){b.log("GBResources::loadCSS - "+c+" is already loaded");return}b.loadedUrls[c]=true;var d=document.createElement("link");d.type="text/css";d.rel="stylesheet";d.href=c;document.getElementsByTagName("head")[0].appendChild(d)},getParamValueFromUrl:function(f,c){f=f.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b="[\\?&]"+f+"=([^&#]*)";var e=new RegExp(b);var d=e.exec(c);if(!d){return""}else{return window.decodeURIComponent(d[1].replace(/\+/g," "))}}})})()}if(!window.gbResources){window.gbResources=new GBResources()}if(window.P&&window.P.AUI_BUILD_DATE){window.gbRegistered=window.gbRegistered||{};window.gbResources.registered=window.gbResources.registered||{};if(!window.gbRegistered.dealResources&&!window.gbResources.registered.dealResources){window.gbRegistered.dealResources=true;window.gbResources.registered.dealResources=true;P.register("dealResources",function(){return window.GBResources})}}else{if(window.amznJQ&&typeof amznJQ==="object"){amznJQ.declareAvailable("dealResources")}};
if(!window.GBDealNotifier){var registerDealScope=function(a){window.GBDealNotifier={};if(!Object.keys){Object.keys=(function(){var d=Object.prototype.hasOwnProperty,e=!({toString:null}).propertyIsEnumerable("toString"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],b=c.length;return function(h){if(typeof h!=="object"&&(typeof h!=="function"||h===null)){throw new TypeError("Object.keys called on non-object")}var f=[],j,g;for(j in h){if(d.call(h,j)){f.push(j)}}if(e){for(g=0;g<b;g++){if(d.call(h,c[g])){f.push(c[g])}}}return f}}())}GBDealNotifier.popoverTrigger=function(d,b,c){if(typeof(amznJQ)==="object"){amznJQ.available("popover",function(){a(d)[b](c)})}else{a(d)[b](c)}};GBDealNotifier.availableStr="Available";GBDealNotifier.inCartStr="InCart";GBDealNotifier.claimedStr="Claimed";GBDealNotifier.expiredStr="Expired";GBDealNotifier.waitInLineStr="WaitInLine";GBDealNotifier.pendingAtcStr="PendingAddToCart";GBDealNotifier.GD_BATCH_SIZE=100;GBDealNotifier.customerStates={NONE:GBDealNotifier.availableStr,INCART:GBDealNotifier.inCartStr,CLAIMED:GBDealNotifier.claimedStr,INWAITLIST:GBDealNotifier.waitInLineStr,PENDINGATC:GBDealNotifier.pendingAtcStr,EXPIRED:GBDealNotifier.expiredStr};GBDealNotifier.responseCustomerStates={NONE:"NONE",INCART:"INCART",CLAIMED:"CLAIMED",INWAITLIST:"INWAITLIST",PENDINGATC:"PENDINGATC",EXPIRED:"EXPIRED"};GBDealNotifier.dealStates={AVAILABLE:"AVAILABLE",EXPIRED:"EXPIRED",SOLDOUT:"SOLDOUT",WAITLIST:"WAITLIST",WAITLISTFULL:"WAITLISTFULL"};GBDealNotifier.DealAccessTypes={PRIME_EARLY_ACCESS:"PRIME_EARLY_ACCESS",PRIME_ONLY_LD:"PRIME_ONLY_LD",PRIME_ONLY_DOTD:"PRIME_ONLY_DOTD"},GBDealNotifier.log=function(b){if(window.gbResources===undefined||window.gbResources===null||!window.gbResources.getDealDebug()){return}b=new Date()+": "+b;if(window.console){window.console.log(b)}else{var c=a("#DealsLog");c.append(a("div").append(b))}};GBDealNotifier.min=function(b){return Math.min.apply(Math,arguments)};GBDealNotifier.max=function(b){return Math.max.apply(Math,arguments)};GBDealNotifier.sortByAsinTimes=function(e,d){var c=e.status.purchaseStatus.expiresDate;var f=d.status.purchaseStatus.expiresDate;return c-f};GBDealNotifier.filterAsinsByState=function(c,d){var f=[];for(var g=0;g<c.length;g++){var e=c[g];for(var b=0;b<d.length;b++){var h=d[b];if(e.status.purchaseStatus.state==h){f.push(e);break}}}return f};GBDealNotifier.commify=function(c,b){c=parseFloat(c);if(b!==undefined){c=c.toFixed(b)}else{c=c.toString()}var f=c.split(".");var e=f[0];for(var d=e.length-3;d>0;d-=3){e=e.substr(0,d)+","+e.substr(d,e.length-d)}if(f.length==2){return e+"."+f[1]}else{return e}};GBDealNotifier.stateAlertsEnum={ATC_EXPIRES_SOON:0,ATC_EXPIRED:1,WL_PATC:2,WL_PATC_EXPIRED:3,WL_SOLD_OUT:4,WL_DEAL_ENDED:5};GBDealNotifier.watchStateAlertEnum={WATCH_DEAL:6};GBDealNotifier.watchDealStates={WD_LIVE:"LIVE",WD_CANCELLED:"CANCELLED"};GBDealNotifier.pStateTypeEnum={CART:0,WAITLIST:1,EITHER:2,NO_ACTION:3,WATCH_DEAL:4};GBDealNotifier.pStateTypeMap={};GBDealNotifier.pStateTypeMap[GBDealNotifier.availableStr]=GBDealNotifier.pStateTypeEnum.NO_ACTION;GBDealNotifier.pStateTypeMap[GBDealNotifier.inCartStr]=GBDealNotifier.pStateTypeEnum.CART;GBDealNotifier.pStateTypeMap[GBDealNotifier.claimedStr]=GBDealNotifier.pStateTypeEnum.NO_ACTION;GBDealNotifier.pStateTypeMap[GBDealNotifier.expiredStr]=GBDealNotifier.pStateTypeEnum.EITHER;GBDealNotifier.pStateTypeMap[GBDealNotifier.waitInLineStr]=GBDealNotifier.pStateTypeEnum.WAITLIST;GBDealNotifier.pStateTypeMap[GBDealNotifier.pendingAtcStr]=GBDealNotifier.pStateTypeEnum.WAITLIST;GBDealNotifier.findDealAsin=function(f,e){var b=this;var c=null;if(e.asins==null){return c}for(var d=0;d<e.asins.length;d++){c=e.asins[d];if(c.asin==f){break}}return c};GBDealNotifier.getPurchaseState=function(f,d){var j="Available";var h=d;if(h==null){if(f!=null&&f.asins!=null){if(f.asins.length>1){var j="Available";var b={};for(var g=0;g<f.asins.length;g++){var e=f.asins[g];var c=GBDealNotifier.getPurchaseState(f,e);if(b[c]){b[c]+=1}else{b[c]=1}}for(var c in b){var k=b[c];if(f.asins.length==k){j=c;break}}return j}else{if(f.asins[0]!=null){h=f.asins[0]}}}else{}}if(h&&h.status&&h.status.purchaseStatus){j=h.status.purchaseStatus.state}else{if(h&&h.isCustomerClaimed){j="Claimed"}else{j="Available"}}return j};GBDealNotifier.isClaimed=function(c,b){return GBDealNotifier.getPurchaseState(c,b)==GBDealNotifier.claimedStr};GBDealNotifier.inState=function(d,c,b){return GBDealNotifier.getPurchaseState(d,c)==b};GBDealNotifier.isSoldOut=function(d){var b=this;if(!d.asins||d.asins.length===0){return false}for(var c=0;c<d.asins.length;c++){if(!d.asins[c].offerServiceSoldOut){if(d.asins[c].status.percentSoldOut<100){return false}}}return true};GBDealNotifier.formatDealTime=function(f){var c=gbResources.getFeature("gbZoneInfo");var g=c.offset;var e=new Date(f.valueOf()+f.getTimezoneOffset()*60*1000+g);var b=e.getHours();var d=e.getMinutes();return GBDealNotifier.formatTime(b,d)};GBDealNotifier.formatTime=function(d,e){if(e<10){e="0"+e}var b=gbResources.getCustomerData("realm");var c=gbResources.getFeature("gbZoneInfo");var g="";if(c){g=c.name}var f=d>=12?gbResources.getString("csld-pm"):gbResources.getString("csld-am");if(b=="US"||b=="UK"||b=="JP"){d=d%12||12}else{if(d<10&&(b=="DE"||b=="FR")){d="0"+d}}return gbResources.getString("csld-start_time",{hours:d,minutes:e,period:f,timezone:g})};GBDealNotifier.formatPricePercentage=function(c){var b=null;if(c==null){b=null}else{if(gbResources.getCustomerData("realm")=="CN"){b=c.toFixed(2)}else{b=Math.round(c)}}return b};GBDealNotifier.getWaitlistHelp=function(f){var b=this;var d="";if(f!=undefined){d=GBDealNotifier.DOM.img({style:"vertical-align:middle;display: inline;",src:f})}var c=GBDealNotifier.DOM.div({"class":"waitlist_help"},[GBDealNotifier.DOM.a({alt:window.gbResources.getString("gbd_what_is_waitlist"),href:"#","class":"waitlist_link"},[window.gbResources.getString("gbd_what_is_waitlist")+" "]),d]);var e=GBDealNotifier.DOM.span({"class":"help_message"},[window.gbResources.getString("csld-waitlist_help")]);GBDealNotifier.popoverTrigger(c,"amazonPopoverTrigger",{showOnHover:true,width:250,showCloseButton:false,location:"over",literalContent:e});return c};GBDealNotifier.isPrimeEligible=function(c){if(c.asins){for(var b=0;b<c.asins.length;b++){if(c.asins[b].isPrimeEligible){return true}}}return false};GBDealNotifier.resizeImage=function(b,c){if(b){b=b.replace(/\.((_.*_)\.)?(gif|jpg)$/,".$2_AA"+c+"_.$3")}return b||""};GBDealNotifier.checkAndSetSSLImageUrl=function(b){if(b==null){return b}if(window.location.protocol=="https:"){b=b.replace(/(http:\/\/[^\/]*\/)(.*$)/,"https://images-na.ssl-images-amazon.com/$2")}return b};GBDealNotifier.Class=function(f,d){var c=f;if(d===undefined){for(var b in d){c[b]=d[b]}}var e=(c&&c.__init__)||function(){};e.prototype=c;return e};GBDealNotifier.dealUrl=function(b){if(b.detail.url){return GBDealNotifier.appendUrlParameter(b.detail.url,"smid",b.merchantID)}else{if(b.asins.length==1){return GBDealNotifier.appendUrlParameter("/gp/product/"+b.asins[0].asin,"smid",b.merchantID)}else{if(b.asins.length>1&&b.parentAsin){return GBDealNotifier.appendUrlParameter("/gp/product/"+b.parentAsin,"smid",b.merchantID)}else{GBDealNotifier.log("fudging title href");return"/gp/goldbox"}}}};GBDealNotifier.appendUrlParameter=function(c,e,d){var b="?";if(c.indexOf("?")!=-1){b="&"}return c+b+e+"="+d};GBDealNotifier.Utilities={checkAndSetSSLImageUrl:function(d){if(d===null){return d}if(window.location.protocol==="https:"){var c="images-na.ssl-images-amazon.com";var b=gbResources.getCustomerData("realm");if(b==="CN"){c="images-cn.ssl-images-amazon.com"}var e=document.createElement("a");e.href=d;e.protocol="https:";e.hostname=c;d=e.href}return d},setDealDetailURL:function(b,c){var e=c?b.teaserAsin:b.reviewAsin;var d="/gp/product/"+e+"/ref=xs_gb_ld_tck_"+b.dealID;return d},setUrlParam:function(e,c,f){var b=e.indexOf("#");var h=b===-1?"":e.substr(b);e=b===-1?e:e.substr(0,b);var d=new RegExp("([?&])"+c+"=.*?(&|$)","i");var g=e.indexOf("?")!==-1?"&":"?";if(e.match(d)){e=e.replace(d,"$1"+c+"="+f+"$2")}else{e=e+g+c+"="+f}return e+h},getDisplayablePercentOff:function(b){if(!b||typeof(b)!=="number"){return null}if(gbResources.getCustomerData("realm")==="CN"){return((100-b)/10)}return b},getFormattedPrice:function(d,b){var c=this;var f=GBDealNotifier.Price.currencies[b];var e=document.createElement("span");if(f){e.innerHTML=f.format(GBDealNotifier.Utilities.commifyNumber(d,f.decimals))}return e.innerHTML},commifyNumber:function(c,b){c=parseFloat(c);if(b!==undefined||b!==null){c=c.toFixed(b)}else{c=c.toString()}var f=c.split(".");var e=f[0];for(var d=e.length-3;d>0;d-=3){e=e.substr(0,d)+","+e.substr(d,e.length-d)}if(f.length===2){return e+"."+f[1]}else{return e}},_loadPrimeDataFromServiceResponse:function(c,b){c.detail.isPrimeEarlyAccessDeal=false;c.detail.isPrimeOnly=false;if(b.primeAccessType==="PRIME_EARLY_ACCESS"&&gbResources.getFeature("prime_early_access")){c.detail.primeAccessType=b.primeAccessType;c.detail.primeAccessDurationInMs=parseInt(b.primeAccessDuration,10)*60*1000;c.detail.isPrimeEarlyAccessDeal=true}else{if(b.primeAccessType==="PRIME_ONLY_LD"&&gbResources.getFeature("prime_only_access")){c.detail.primeAccessType=b.primeAccessType;c.detail.isPrimeOnly=true}else{if(b.primeAccessType==="PRIME_ONLY_DOTD"&&gbResources.getFeature("prime_only_access")){c.detail.primeAccessType="PRIME_ONLY_DOTD";c.detail.isPrimeOnly=true}}}return c},_loadReviewsFromServiceResponse:function(c,b){if(b.reviewAsin){c.reviews.URL="/gp/product-reviews/"+b.reviewAsin}if(b.totalReviews!==null&&b.totalReviews!==undefined){c.reviews.total=parseInt(b.totalReviews,10)}if(b.reviewRating!==null&&b.reviewRating!==undefined){c.reviews.rating=parseFloat(b.reviewRating)}return c},_loadPricingDataFromServiceResponse:function(e,c){var i=null;if(c.itemType==="VARIATION_ITEM"){for(var g in c.items){var k=c.items[g];if(k.itemID===c.reviewAsin){i=k;break}}}if(i){e.pricingData.prices.dealPrice={max:{value:parseFloat(i.dealPrice)},min:{value:parseFloat(i.dealPrice)}}}else{if(c.maxDealPrice!==null&&c.maxDealPrice!==undefined&&c.minDealPrice!==null&&c.minDealPrice!==undefined){e.pricingData.prices.dealPrice={max:{value:parseFloat(c.maxDealPrice)},min:{value:parseFloat(c.minDealPrice)}}}}if(i){e.pricingData.prices.basisPrice={max:{value:parseFloat(i.bAmount)},min:{value:parseFloat(i.bAmount)}}}else{if(c.maxBAmount!==null&&c.maxBAmount!==undefined&&c.minBAmount!==null&&c.minBAmount!==undefined){e.pricingData.prices.basisPrice={max:{value:parseFloat(c.maxBAmount)},min:{value:parseFloat(c.minBAmount)}}}}if(i){e.pricingData.percentOff=GBDealNotifier.Utilities.getDisplayablePercentOff(i.percentOff)}else{if(c.maxPercentOff&&c.minPercentOff){maxPercentOff=parseInt(c.maxPercentOff);minPercentOff=parseInt(c.minPercentOff);if(maxPercentOff===minPercentOff){e.pricingData.percentOff=GBDealNotifier.Utilities.getDisplayablePercentOff(maxPercentOff)}}}if(c.pricePerUnit!==null&&c.pricePerUnit!==undefined){e.pricingData.unitPrice={value:parseFloat(c.pricePerUnit)};e.pricingData.unitPrice.formattedValue=GBDealNotifier.Utilities.getFormattedPrice(e.pricingData.unitPrice.value,e.currencyCode)}if(c.baseUnitValue!==null&&c.baseUnitValue!==undefined&&c.baseUnitName!==null&&c.baseUnitName!==undefined){e.pricingData.baseUnit={value:c.baseUnitValue,name:c.baseUnitName}}var d=e.pricingData.prices;for(var h in d){if(d[h]!==null||d[h]!==undefined){var j=d[h];for(var b in j){var f=j[b].value;j[b].formattedValue=GBDealNotifier.Utilities.getFormattedPrice(f,e.currencyCode)}}}if(c.bKind){e.pricingData.bKind=c.bKind}return e}};GBDealNotifier.Signal={methods:["connect","disconnectAll","signal"],init:function(d){var b=this;var c;var e;if(d.__signals__){throw new Error("already registered")}if(d.signals===undefined){throw new Error("expected 'signals' attribute")}for(c=0;c<this.methods.length;c++){e=this.methods[c];if(d[e]!==undefined){throw new Error("method "+e+" is already defined")}}d.__signals__={};for(c=0;c<d.signals.length;c++){d.__signals__[d.signals[c]]={}}for(c=0;c<this.methods.length;c++){e=this.methods[c];d[e]=this[e]}},next_id:100,connect:function(d,e,g){var c=this;if(c.__signals__[d]===undefined){throw new Error("no such signal "+d)}var f=GBDealNotifier.Signal.next_id++;var b={signals:["disconnect"],disconnect:function(){delete c.__signals__[d][f];this.signal("disconnect");this.disconnect=function(){}}};if(e instanceof Function){b.trigger=e}else{if(e[g]===undefined){throw new Error("method '"+g+"' for obj "+e+" doesn't exist")}if(!e[g] instanceof Function){throw new Error("method '"+g+"' for obj "+e+" isn't a Function")}b.trigger=function(){e[g].apply(e,arguments)}}c.__signals__[d][f]=b;GBDealNotifier.Signal.init(b);return b},disconnectAll:function(c){var b=this;var d;if(c){if(b.__signals__[c]===undefined){throw new Error("no such signal "+c)}var e;for(e in this.__signals__[c]){this.__signals__[c][e].disconnect()}return}for(d in this.__signals__){this.disconnectAll(d)}},signal:function(j){var l=this;if(l.__signals__[j]===undefined){throw new Error("no such signal "+j)}var g=[];var d=1;if(arguments.length==1){d=0}for(d;d<arguments.length;d++){g.push(arguments[d])}var k=[];for(var b in this.__signals__[j]){var c=this.__signals__[j][b];try{c.trigger.apply(c,g)}catch(f){k.push(f)}}if(k.length>1){var h=new Error("multiple errors. See 'errors'");h.errors=k;throw h}else{if(k.length==1){throw k[0]}}}};GBDealNotifier.Service=GBDealNotifier.Class({__init__:function(c){var b=this;if(!c.marketplace_id){throw new Error("must specify 'marketplace_id'")}b.marketplace_id=c.marketplace_id;b.customer_id=c.customer_id;b.session_id=c.session_id;b.timeout=c.timeout||5*60*1000;b.includeVariations=c.includeVariations},ajax_with_retries:function(g){var d=this;var h=new Date();var c=0;var f=g.retryInterval||GBDealNotifier.Service.base_retry_interval||60000;delete g.retryInterval;var e=g.error;delete g.error;var b=function(){if(!GBDealNotifier.Service.continue_requests){e(new Error("continue_requests is false: no more requests should be made."));return}if(g.url.indexOf("?")==-1){g.url=g.url+"?nocache="+new Date().getTime()}else{g.url=g.url+"&nocache="+new Date().getTime()}g.error=function(j){var i=f*(1+Math.pow(2,c++)*Math.random());if(i+new Date().getTime()-h.getTime()>d.timeout){e(new Error("Retries timed out"+JSON.stringify(j)))}else{GBDealNotifier.log("retrying after "+i+"ms");window.setTimeout(b,i)}};a.ajax(g)};b()},call:function(d,e,h,c,g){var b=this;var f={success:function(i){if(i.responseMetadata){GBDealNotifier.Service.base_retry_interval=i.responseMetadata.baseRetryInterval;GBDealNotifier.Service.continue_requests=i.responseMetadata.continueRetries}h(i)},error:c,url:d,type:"POST",data:JSON.stringify(e),dataType:"json"};if(g!==undefined){f.retryInterval=g}b.ajax_with_retries(f)},get_deal_metadata:function(e,c,b){var d=this;d.call("/xa/goldbox/GetDealMetadata",{requestMetadata:{marketplaceID:d.marketplace_id},filters:e.filters,orderings:e.orderings,includeVariations:d.includeVariations},c,b)},_deal_ids_from_callbacks:function(d){var b=[];var c;for(c in d){b.push(c)}return b},get_deals:function(f,e){var b=this;var d=b._deal_ids_from_callbacks(f);var c;if(e==null){e=GBDealNotifier.Service.DealIDDealFilter(d)}b.call("/xa/goldbox/GetDeals",{requestMetadata:{marketplaceID:b.marketplace_id},customerID:b.customer_id,filter:e,ordering:[],page:1,resultsPerPage:d.length,includeVariations:b.includeVariations},function(g){var h={};for(c=0;c<g.deals.length;c++){var j=g.deals[c];f[j.dealID][0](j);h[j.dealID]=true}for(c=0;c<d.length;c++){var i=d[c];if(!h[i]){f[i][1](new Error("No deal returned for dealID "+i))}}},function(g){for(c=0;c<d.length;c++){var h=d[c];f[h][1](g)}})},get_deal_statuses:function(d){var b=this;var c=b._deal_ids_from_callbacks(d);b.call("/xa/goldbox/GetDealStatus",{requestMetadata:{marketplaceID:b.marketplace_id},dealIDs:c},function(e){var f={};var j;var h;var g;for(j in e.dealStatus){h=e.dealStatus[j];d[h.dealID][0](h);f[h.dealID]=true}for(g=0;g<c.length;g++){j=c[g];if(!f[j]){d[j][1](new Error("No status returned for dealID "+j))}}},function(e){var f;var g;for(f=0;f<c.length;f++){g=c[f];d[g][1](e)}})},get_deal_asin_statuses:function(d){var b=this;var c=b._deal_ids_from_callbacks(d);GBDealNotifier.log("Calling GetDealAsinStatus: "+c);b.call("/xa/goldbox/GetDealAsinStatus",{requestMetadata:{marketplaceID:b.marketplace_id},customerID:b.customer_id,filter:GBDealNotifier.Service.DealIDDealFilter(c)},function(e){var m=e.dealAsinStatuses;var j={};var l=[];var h={};for(var g=0;g<m.length;g++){var k=m[g];j[k.asin]=k;h[k.dealID]=1}for(var f in h){d[f][0](j)}},function(e){for(var f=0;f<c.length;f++){var g=c[f];d[g][1](e)}})},get_deal_asin_status:function(d,e,c){var b=this;b.call("/xa/goldbox/GetDealAsinStatus",{requestMetadata:{marketplaceID:b.marketplace_id},customerID:b.customer_id,dealID:d},e,c)},get_deal_asin_status2:function(d,e,c){var b=this;return b._add_request("get_deal_asin_status",d,e,c)},redeem_deal:function(d,e,f,c){var b=this;b.call("/gp/deal/ajax/redeemDeal.html?marketplaceID="+gbResources.getCustomerData("marketplaceId")+"&dealID="+d+"&asin="+e+"&sessionID="+b.session_id,{},f,c,GBDealNotifier.Service.base_retry_interval/4)},claim_deal:function(d,e,f,c){var b=this;b.call("/gp/deal/ajax/claimDeal.html?dealId="+d+"&itemId="+e,{},f,c,GBDealNotifier.Service.base_retry_interval/4)},_pending:{get_deal:{current:false,timeout:undefined,deal_ids:{}},get_deal_status:{current:false,timeout:undefined,deal_ids:{}},get_deal_asin_status:{current:false,timeout:undefined,deal_ids:{}}},next_id:100,get_deal:function(d,e,c){var b=this;return b._add_request("get_deal",d,e,c)},get_deal_status:function(d,e,c){var b=this;return b._add_request("get_deal_status",d,e,c)},_add_request:function(h,e,j,i){var k=this;var c=k._pending[h];if(c.deal_ids[e]===undefined){c.deal_ids[e]={}}var g=c.deal_ids[e];var b=k.next_id++;var f={cancel:function(){delete g[b];this.cancel=function(){throw new Error("already cancelled")}},success:j,error:i};g[b]=f;k._start_request_timer(h);return f},_start_request_timer:function(c){var b=this;var d=b._pending[c];if(!d.current){if(d.timeout){window.clearTimeout(d.timeout)}d.timeout=window.setTimeout(function(){d.timeout=undefined;b._start_request(c)},100)}},_start_request:function(e){var b=this;var g=b._pending[e];if(g.timeout){window.clearTimeout(g.timeout);g.timeout=undefined}if(g.current){return}var c=[];var f={};for(var d in g.deal_ids){if(c.length>=10){break}var i=false;for(var h in g.deal_ids[d]){i=true;break}if(!i){delete g.deal_ids[d];break}if(g.deal_ids[d].current){continue}g.deal_ids[d].current=true;c.push(d);(function(j){f[j]=[function(k){b._request_success(e,j,k)},function(k){b._request_error(e,j,k)}]})(d)}if(c.length===0){return}if(e=="get_deal"){b.get_deals(f)}else{if(e=="get_deal_status"){b.get_deal_statuses(f)}else{if(e=="get_deal_asin_status"){b.get_deal_asin_statuses(f)}}}},_request_success:function(e,c,g){var b=this;var f=b._pending[e];f.current=false;var h=f.deal_ids[c];if(h!==undefined){delete f.deal_ids[c];delete h.current;for(var i in h){h[i].success(g)}}b._start_request_timer(e)},_request_error:function(f,e,c){var b=this;var g=b._pending[f];g.current=false;var h=g.deal_ids[e];if(h!==undefined){delete g.deal_ids[e];delete h.current;for(var i in h){h[i].error(c)}}b._start_request_timer(f)}});GBDealNotifier.Service.base_url="http://internal.amazon.com/coral/com.amazon.DealService.model/";GBDealNotifier.Service.AndDealFilter=function(b){return{__type:"AndDealFilter:"+GBDealNotifier.Service.base_url,children:b}};GBDealNotifier.Service.OrDealFilter=function(b){return{__type:"OrDealFilter:"+GBDealNotifier.Service.base_url,children:b}};GBDealNotifier.Service.DealIDDealFilter=function(b){return{__type:"DealIDDealFilter:"+GBDealNotifier.Service.base_url,dealIDs:b}};GBDealNotifier.Service.SlotDealFilter=function(b){return{__type:"SlotDealFilter:"+GBDealNotifier.Service.base_url,slots:b}};GBDealNotifier.Service.AsinDealFilter=function(b){return{__type:"AsinDealFilter:"+GBDealNotifier.Service.base_url,asins:b}};GBDealNotifier.Service.AvailableDealFilter=function(){return{__type:"AvailableDealFilter:"+GBDealNotifier.Service.base_url}};GBDealNotifier.Service.StartDateDealFilter=function(c,b){return{__type:"StartDateDealFilter:"+GBDealNotifier.Service.base_url,from:(c instanceof Date?c.valueOf():c),to:(b instanceof Date?b.valueOf():b)}};GBDealNotifier.Service.EndDateDealFilter=function(c,b){return{__type:"EndDateDealFilter:"+GBDealNotifier.Service.base_url,from:(c instanceof Date?c.valueOf():c),to:(b instanceof Date?b.valueOf():b)}};GBDealNotifier.Service.SoldOutDealFilter=function(b){return{__type:"SoldOutDealFilter:"+GBDealNotifier.Service.base_url,soldOut:b}};GBDealNotifier.Service.ClaimedDealFilter=function(b){return{__type:"ClaimedDealFilter:"+GBDealNotifier.Service.base_url,claimed:b}};GBDealNotifier.Service.StartDateDealOrder=function(){return{__type:"StartDateDealOrder:"+GBDealNotifier.Service.base_url}};GBDealNotifier.Service.NextAvailableDealOrder=function(){return{__type:"NextAvailableDealOrder:"+GBDealNotifier.Service.base_url}};GBDealNotifier.Service.BucketDealOrder=function(b){return{__type:"BucketDealOrder:"+GBDealNotifier.Service.base_url,slots:b}};GBDealNotifier.Model={};GBDealNotifier.Model.Metadata=GBDealNotifier.Class({__init__:function(g,e){var b=this;b.filters=g;for(var d in b.filters){var h=b.filters[d];b.filters[d]={};for(var c=0;c<h.length;c++){b.filters[d][h[c]]=true}}b.orderings=e},get_deal_ids:function(g,h){var b=this;g=b.filters[g];if(h){h=b.orderings[h]}else{h=[]}var e=[];var c={};var d;var f;for(d=0;d<h.length;d++){f=h[d];c[f]=true;if(g[f]){e.push(f)}}for(f in g){if(!c[f]){e.push(f)}}return e}});GBDealNotifier.Model.Deals=GBDealNotifier.Class({__init__:function(f){var c=this;c.deals={};for(var d=0;d<f.length;d++){var e=f[d];var b=c.get_deal(e.dealID);b.load_from_deal(e)}},get_deal:function(b){if(this.deals[b]===undefined){this.deals[b]=new GBDealNotifier.Model.Deal(b)}return this.deals[b]}});GBDealNotifier.Model.Deal=GBDealNotifier.Class({signals:["change","expire","status_expire","pstatus_expires_soon","pstatus_expire"],__init__:function(c){var b=this;GBDealNotifier.Signal.init(b);b.dealID=c;b.timeouts={};b.loading=true;b.expired=true;b.status={expired:true};b.detail={};b.asins=[];b.reviews={URL:null,total:null,rating:null};b.pricingData={dealPrice:null,basisPrice:null,percentOff:null};b.merchantName=null;b.asinExpiresSoonStack=[];b.asinExpiredStack=[];b.purchaseStatusWarningThreshold=10*60*1000},_init_status:function(c){var b=this;b.status.cacheExpiresDate=new Date(c.getTime()+parseInt(b.status.msToCacheExpires,10));b.status.expired=false;b.status.startDate=new Date(c.getTime()+parseInt(b.status.msToStart,10));b.status.started=b.status.msToStart<=0;b.status.endDate=new Date(c.getTime()+parseInt(b.status.msToEnd,10));b.status.ended=b.status.msToEnd<=0;if(b.timeouts.start_timeout){window.clearTimeout(b.timeouts.start_timeout)}if(!b.status.started){b.timeouts.start_timeout=window.setTimeout(function(){b.status.started=true;b.signal("change",b)},b.status.startDate.getTime()-new Date().getTime())}if(b.timeouts.end_timeout){window.clearTimeout(b.timeouts.end_timeout)}if(!b.status.ended){b.timeouts.end_timeout=window.setTimeout(function(){b.status.ended=true;b.signal("change",b)},b.status.endDate.getTime()-new Date().getTime())}if(b.timeouts.status_expire_timeout){window.clearTimeout(b.timeouts.status_expire_timeout)}b.timeouts.status_expire_timeout=window.setTimeout(function(){b.status.expired=true;b.signal("status_expire",b)},b.status.cacheExpiresDate.getTime()-new Date().getTime())},_init_asin_statuses:function(){var b=this;if(!b.asins){GBDealNotifier.log("No Asins, not initializing statuses.");return}var d=new Date();var c=GBDealNotifier.filterAsinsByState(b.asins,[GBDealNotifier.inCartStr,GBDealNotifier.expiredStr,GBDealNotifier.waitInLineStr,GBDealNotifier.pendingAtcStr]);for(var e=0;e<c.length;e++){var h=c[e];if(b.purchaseStatusWarningThreshold){h.status.purchaseStatus.expiresDate=new Date(d.getTime()+parseInt(h.status.purchaseStatus.msToExpiry,10))}}c.sort(GBDealNotifier.sortByAsinTimes);b.asinExpiresSoonStack=[];b.asinExpiredStack=[];for(var e=0;e<c.length;e++){var h=c[e];if(b.timeouts.pstatus_exp_soon[h.asin]){window.clearTimeout(b.timeouts.pstatus_exp_soon[h.asin])}var g=h.status.purchaseStatus.expiresDate.getTime()-new Date().getTime();var f=g-b.purchaseStatusWarningThreshold;if(f<0){f=0}var j=""+h.asin;if(g>0&&h.status.purchaseStatus.state!=GBDealNotifier.waitInLineStr&&h.status.purchaseStatus.state!=GBDealNotifier.pendingAtcStr){b.asinExpiresSoonStack.push(j);b.timeouts.pstatus_exp_soon[j]=window.setTimeout(function(){var i=b.asinExpiresSoonStack.shift();b.signal("pstatus_expires_soon",b,i)},f)}if(b.timeouts.pstatus_expire[h.asin]){window.clearTimeout(b.timeouts.pstatus_expire[h.asin])}b.asinExpiredStack.push(j);b.timeouts.pstatus_expire[h.asin]=window.setTimeout(function(){var i=b.asinExpiredStack.shift();b.signal("pstatus_expire",b,i);b.signal("change",b)},g)}},load_from_deal:function(f){var c=this;var d=new Date();var b;for(b in f){c[b]=f[b]}c.loading=false;c.startDate=new Date(c.startDate*1000);c.endDate=new Date(c.endDate*1000);c.cacheExpiresDate=new Date(d.getTime()+parseInt(c.msToCacheExpires,10));c.expired=false;if(c.timeouts.expire_timeout){window.clearTimeout(c.timeouts.expire_timeout)}c.timeouts.expire_timeout=window.setTimeout(function(){c.expired=true;c.signal("expire",c)},c.cacheExpiresDate.getTime()-new Date().getTime());c.limitedQuantity=c.limitedQuantity=="1";if(c.customer){c.customer.claimed=c.customer.claimed=="1"}if(c.asins){if(!c.timeouts.pstatus_exp_soon){c.timeouts.pstatus_exp_soon={}}if(!c.timeouts.pstatus_expire){c.timeouts.pstatus_expire={}}for(var e=0;e<c.asins.length;e++){c.asins[e].offerServiceSoldOut=c.asins[e].offerServiceSoldOut=="1"}}c._init_status(d);c._init_asin_statuses();c.signal("change",c)},load_from_status:function(b){var c=this;c.status=b;c._init_status(new Date());c.signal("change",c)},load_from_asin_status:function(e){var b=this;if(b.asins==null){return}if(e==null){return}var f=e.asin;for(var c=0;c<b.asins.length;c++){var d=b.asins[c];if(d.asin==f){b.asins[c].status=e;break}}b._init_asin_statuses();b.signal("change",b)},setPurchaseStatusWarningThreshold:function(b){if(b>0){self.purchaseStatusWarningThreshold=b}else{self.purchaseStatusWarningThreshold=2*60*1000}},getPurchaseStatusWarningThreshold:function(){var b=this;return b.purchaseStatusWarningThreshold},_loadFromDealDAO:function(d){var l=this;var b=new Date();l.loading=false;var m=gbResources.customerData.marketplaceId;l.marketplaceID=m;l.merchantName=d.merchantName;l.merchantID=d.merchantID;l.dealID=d.dealID;l.legacyDealID=d.legacyDealID;l.startDate=d.status.dates.start;l.endDate=d.status.dates.end;l.msToCacheExpires=d.status.timeouts.cacheExpires;l.cacheExpiresDate=d.status.dates.cacheExpires;l.status={marketplaceID:m,dealID:d.dealID,percentClaimed:d.status.percentClaimed,msToStart:d.status.timeouts.start,startDate:d.status.dates.start,started:d.status.timeouts.start<=0,msToEnd:d.status.timeouts.end,endDate:d.status.dates.end,ended:d.status.timeouts.end<=0,msToCacheExpires:d.status.timeouts.cacheExpires,cacheExpiresDate:d.status.dates.cacheExpires,expired:false};l.detail={marketplaceID:m,dealID:d.dealID,title:d.detail.title,description:d.detail.description,imageAsin:d.detail.imageAsin,url:d.detail.URL,buyBoxUrl:d.detail.buyAsin};l.asins=[];var i=d.items;var c=undefined;if(i.constructor===Array){c=i.length}else{if(i.constructor===Object){c=Object.keys(i).length}}if(!c||c===0){var h=d.dealState;var j=GBDealNotifier.customerStates[d.customerState];var f={marketplaceID:m,dealID:d.dealID,asin:d.detail.buyAsin,basisPrice:d.pricingData.prices.basisPrice?d.pricingData.prices.basisPrice.min.formattedValue:"",dealPrice:d.pricingData.prices.dealPrice?d.pricingData.prices.dealPrice.min.formattedValue:"",basisKind:d.pricingData.bKind,percentOff:d.pricingData.percentOff,offerServiceSoldOut:h==="SOLDOUT"?true:false,variationData:d.variationDimensions,imageURL:d.detail.imageAsin,isCustomerClaimed:j===GBDealNotifier.claimedStr?true:false,status:{marketplaceID:m,dealID:d.dealID,asin:d.detail.buyAsin,percentClaimed:h==="SOLDOUT"?100:d.status.percentSoldOut,percentSoldOut:d.status.percentSoldOut,itemState:h,currentlyUnavailable:h==="WAITLISTFULL"?true:false,purchaseStatus:{state:j,msToExpiry:d.status.dates.incartEnds-new Date()}}};l.asins.push(f)}else{for(var k in i){var e=i[k];var g=e.status.itemState;var j=GBDealNotifier.customerStates[e.status.customerState];var f={marketplaceID:m,dealID:d.dealID,asin:e.asinID,basisPrice:e.basisPriceFormatted,basisKind:e.bKind,dealPrice:e.dealPriceFormatted,percentOff:e.percentOff,offerServiceSoldOut:g==="SOLDOUT"?true:false,variationData:e.variationDimensions,imageURL:e.imageURL,isCustomerClaimed:j===GBDealNotifier.claimedStr?true:false,status:{marketplaceID:m,dealID:d.dealID,asin:e.asinID,percentClaimed:e.status.percentClaimed,percentSoldOut:g==="SOLDOUT"?100:d.status.percentSoldOut,itemState:g,currentlyUnavailable:g==="WAITLISTFULL"?true:false,purchaseStatus:{state:j,msToExpiry:e.status.dates.incartEnds-new Date()}}};l.asins.push(f)}}l.customer={marketplaceID:m,dealID:d.dealID,customerID:gbResources.customerData.customerId,claimed:false};l.pricingData=d.pricingData;l.reviews=d.reviews},_loadStatusFromDealDAO:function(d){var b=this;var c=new Date();b._loadFromDealDAO(d);if(b.timeouts.expire_timeout){window.clearTimeout(b.timeouts.expire_timeout)}if(b.cacheExpiresDate){b.timeouts.expire_timeout=window.setTimeout(function(){b.expired=true;b.signal("expire",b)},b.cacheExpiresDate.getTime()-new Date().getTime())}if(b.asins){if(!b.timeouts.pstatus_exp_soon){b.timeouts.pstatus_exp_soon={}}if(!b.timeouts.pstatus_expire){b.timeouts.pstatus_expire={}}}b._init_status(c);b._init_asin_statuses();b.signal("change",b)}});GBDealNotifier.Model.WatchDeal=GBDealNotifier.Class({__init__:function(c){var b=this;b.dealID=c;b.merchantName=null;b.legacyDealID=null;b.currencyCode=null;b.customerState=null;b.status={dealID:null,dealState:null,startDate:null,endDate:null,msToStart:null,msToEnd:null,percentClaimed:null,isValidDeal:1};b.detail={title:null,imageAsin:null,URL:null,itemType:null,buyAsin:null,primeAccessType:null,marketingMessage:null,isPrimeOnly:null,isPrimeEarlyAccessDeal:null,isFulfilledByAmazon:null,egressUrl:null};b.customerData={marketplaceID:null,dealID:null,customerID:null};b.reviews={URL:null,total:null,rating:null};b.pricingData={prices:{dealPrice:null,basisPrice:null},percentOff:null,bKind:null,unitPrice:null,baseUnit:null}},_loadFromDealDAO:function(f){var e=this;e.dealID=f.dealID;e.merchantName=f.merchantName;e.legacyDealID=f.legacyDealID;e.status.dealID=f.dealID;e.status.dealState=f.status.dealState;e.status.startDate=f.status.startDate;e.status.endDate=f.status.endDate;e.status.msToStart=f.status.msToStart;e.status.msToEnd=f.status.msToEnd;e.status.percentClaimed=f.status.percentClaimed;e.status.isValidDeal=f.status.isValidDeal;var d=f.detail;e.detail.dealID=f.dealID;e.detail.title=d.title;e.detail.description=d.description;e.detail.imageAsin=d.imageAsin;e.detail.URL=d.URL;e.detail.buyBoxUrl=d.buyBoxURL;e.detail.itemType=d.itemType;e.detail.buyAsin=d.buyAsin;e.detail.primeAccessType=d.primeAccessType;e.detail.marketingMessage=d.marketingMessage;e.detail.isPrimeOnly=d.isPrimeOnly;e.detail.isPrimeEarlyAccessDeal=d.isPrimeEarlyAccessDeal;e.detail.isFulfilledByAmazon=d.isFulfilledByAmazon;e.customerData.marketplaceID=f.detail.marketplaceID;e.customerData.dealID=f.dealID;e.customerData.customerID=f.customerID;var c=f.reviews;e.reviews.URL=c.URL;e.reviews.total=c.total;e.reviews.rating=c.rating;var b=f.pricingData;e.pricingData.prices.dealPrice=b.prices.dealPrice;e.pricingData.prices.basisPrice=b.prices.basisPrice;e.pricingData.percentOff=b.percentOff;e.pricingData.bKind=b.bKind;e.pricingData.unitPrice=b.unitPrice;e.pricingData.baseUnit=b.baseUnit},_loadDetailsFromServiceResponse:function(b){var c=this;c.merchantName=b.merchantName;c.legacyDealID=b.legacyDealID;c.detail.dealID=b.dealID;c.detail.title=b.title;c.detail.egressUrl=b.egressUrl;c.detail.description=b.description;c.currencyCode=b.currencyCode;if(b.primaryImage){c.detail.imageAsin=GBDealNotifier.Utilities.checkAndSetSSLImageUrl(b.primaryImage)}c.detail.URL=GBDealNotifier.Utilities.setDealDetailURL(b,false);c.detail.itemType=b.itemType;c.detail.buyAsin=b.reviewAsin;c.detail.marketingMessage=b.marketingMessage;c.detail.isFulfilledByAmazon=b.isFulfilledByAmazon;GBDealNotifier.Utilities._loadPrimeDataFromServiceResponse(c,b);GBDealNotifier.Utilities._loadReviewsFromServiceResponse(c,b);GBDealNotifier.Utilities._loadPricingDataFromServiceResponse(c,b)},_loadStatusFromServiceResponse:function(b){var c=this;c.status.dealID=b.dealID;c.status.dealState=b.dealState;c.status.msToStart=b.msToStart;c.status.msToEnd=b.msToEnd;c.status.isValidDeal=b.isValid;if(b.percentClaimed!==undefined&&b.percentClaimed!==null){c.status.percentClaimed=parseInt(b.percentClaimed,10)}},_updateTeaserDetails:function(b){var c=this;if(c.status.dealState==="UPCOMING"||c.status.dealState==="COMINGSOON"){if(b.teaser&&b.teaserImage){c.detail.imageAsin=GBDealNotifier.Utilities.checkAndSetSSLImageUrl(b.teaserImage)}c.detail.URL=GBDealNotifier.Utilities.setDealDetailURL(b,true)||""}}});GBDealNotifier.Price={currencies:{USD:{decimals:2,format:function(b){return"$"+b}},GBP:{decimals:2,format:function(b){return"&pound;"+b}},EUR:{decimals:2,format:function(b){return("EUR "+b).replace(".",",")}},JPY:{decimals:0,format:function(b){return"&yen; "+b}},CNY:{decimals:2,format:function(b){return"&yen; "+b}},CAD:{decimals:2,format:function(b){return("C$"+b).replace(",","")}},INR:{decimals:2,format:function(b){return"&#8377;"+b}},BRL:{decimals:2,format:function(b){return"R$ "+b}},MXN:{decimals:2,format:function(b){return"$"+b}}},make_price:function(b,c){return{currency:b,price:c}},test_same_currency:function(d,c){if(d.currency!=c.currency){throw new Error("Currencies don't match: "+d.currency+" and "+c.currency)}},minus:function(d,c){if(!d||!c){return undefined}this.test_same_currency(d,c);return this.make_price(d.currency,d.price-c.price)},percent_off:function(b,c){if(!b||!c){return undefined}this.test_same_currency(b,c);var d=b.price-c.price;if(gbResources.getCustomerData("realm")=="CN"){return(1-(d/b.price))*10}return d*100/b.price},format:function(b,e){if(!b||!b.price){return e}var d=this.currencies[b.currency];if(!d){d={decimals:2,format:function(f){return f+" "+f.currency}}}var c=GBDealNotifier.DOM.span();a(c).html(d.format(GBDealNotifier.commify(b.price,d.decimals)));return c.innerHTML}};GBDealNotifier.getListPrice=function(c,b){if(b=="US"||b=="FR"||b=="JP"||b=="CN"){return c.asins[0].listPrice}else{return null}};GBDealNotifier.getOurPrice=function(e,d){var b=GBDealNotifier.getListPrice(e,d);var c=e.asins[0].ourPrice;if(!c||d=="FR"){return null}else{if(d=="JP"){if(!b||parseFloat(c.price)<parseFloat(b.price)){return c}else{return null}}else{return c}}};GBDealNotifier.getDiscount=function(f,d){var b=GBDealNotifier.getListPrice(f,d);var c=GBDealNotifier.getOurPrice(f,d);var e=f.asins[0].dealPrice;if(b!=null&&e!=null){return GBDealNotifier.Price.minus(b,e)}else{if(c!=null&&e!=null){return GBDealNotifier.Price.minus(c,e)}else{return null}}};GBDealNotifier.getOurPricePercentOff=function(e,d){var b=GBDealNotifier.getListPrice(e,d);var c=GBDealNotifier.getOurPrice(e,d);if(b!=null&&c!=null){return GBDealNotifier.formatPricePercentage(GBDealNotifier.Price.percent_off(b,c))}else{return null}};GBDealNotifier.getDealPricePercentOff=function(f,d){var b=GBDealNotifier.getListPrice(f,d);var c=GBDealNotifier.getOurPrice(f,d);var e=f.asins[0].dealPrice;if(b!=null&&e!=null){return GBDealNotifier.formatPricePercentage(GBDealNotifier.Price.percent_off(b,e))}else{if(c!=null&&e!=null){return GBDealNotifier.formatPricePercentage(GBDealNotifier.Price.percent_off(c,e))}else{return null}}};GBDealNotifier.round=function(c,d){var b=Math.round(c*Math.pow(10,d))/Math.pow(10,d);return b};GBDealNotifier.Controller=GBDealNotifier.Class({signals:["cell_change","page_change","metadata_change"],__init__:function(c){var b=this;GBDealNotifier.Signal.init(b);GBDealNotifier.Service.base_retry_interval=c.base_retry_interval||60000;GBDealNotifier.Service.continue_requests=c.continue_requests||true;b.login_uri=c.login_uri;b.images=c.images;b.service=new GBDealNotifier.Service({marketplace_id:c.marketplace_id,customer_id:c.customer_id,session_id:c.session_id,timeout:c.timeout,includeVariations:c.includeVariations});b.buying={};b.deals=new GBDealNotifier.Model.Deals(c.deals);b.metadata=new GBDealNotifier.Model.Metadata(c.filters,c.orderings);b.browseNodes=c.browseNodes;b.ordering=c.ordering;b.statuses={available:GBDealNotifier.Service.AndDealFilter([GBDealNotifier.Service.EndDateDealFilter("now",null),GBDealNotifier.Service.SoldOutDealFilter(false)]),upcoming:GBDealNotifier.Service.StartDateDealFilter("now",null),sold_out:GBDealNotifier.Service.SoldOutDealFilter(true),expired:GBDealNotifier.Service.EndDateDealFilter(null,"now")};b.varPopCloseFunction=null;b.connections=[];b.cells=1;b.cell_to_deal={};b.deal_id_to_cell={};b.page=1;b.pages=1;b.filter=undefined;b.order=undefined;b.deal_ids=[]},closeVarPopover:function(){var b=this;if(b.varPopCloseFunction){b.varPopCloseFunction()}},setVarPopCloseFunction:function(b){var c=this;c.closeVarPopover();c.varPopCloseFunction=b},_calc_deal_ids:function(){var b=this;b.deal_ids=b.metadata.get_deal_ids(b.filter,b.order);b._calc_pages()},_calc_pages:function(){var b=this;b.pages=Math.ceil(b.deal_ids.length/b.cells)},set_status:function(b){var c=this;if(!c.statuses[b]){throw new Error("No such status '"+b+"'")}c.status=b;var d=c.statuses[b];var e={all:GBDealNotifier.Service.AndDealFilter([d,GBDealNotifier.Service.SlotDealFilter(["LD:ALL"])]),gbld:GBDealNotifier.Service.AndDealFilter([d,GBDealNotifier.Service.SlotDealFilter(["GBLD:ALL"])])};for(var f in c.browseNodes){e[f]=GBDealNotifier.Service.AndDealFilter([d,c.browseNodes[f]])}c.service.get_deal_metadata({filters:e,orderings:{start:c.ordering}},function(g){c.metadata=new GBDealNotifier.Model.Metadata(g.filters,g.orderings);c.signal("metadata_change")},function(g){GBDealNotifier.log("error="+g)})},set_filter:function(c){var b=this;if(!b.metadata.filters[c]){throw new Error("Invalid filter: "+c)}b.filter=c;b._calc_deal_ids()},set_ordering:function(c){var b=this;if(!b.metadata.orderings[c]){throw new Error("Invalid ordering: "+c)}b.order=c;if(b.filter){b._calc_deal_ids()}},set_cells:function(c){var b=this;if(c<1){throw new Error("Invalid number of cells: "+c)}b.cells=c;b._calc_pages()},prev_page:function(c){var b=this;if(b.page==1){if(c){b.set_page(b.pages)}else{throw new Error("already at first page")}}else{b.set_page(b.page-1)}},next_page:function(c){var b=this;if(b.page<b.pages){b.set_page(b.page+1)}else{if(c){b.set_page(1)}else{throw new Error("already at last page")}}},set_page_to_show_deal:function(d){var b=this;if(!d){b.set_page(1);return}var c;for(c=0;c<b.deal_ids.length;c++){if(b.deal_ids[c]==d){break}}if(c==b.deal_ids.length){GBDealNotifier.log("couldn't find deal id "+d);b.set_page(1);return}b.set_page(Math.floor(c/b.cells)+1)},set_page:function(f){var c=this;var b;var d;var g;var e;if(c.pages===0){for(b=0;b<c.cells;b++){c.signal("cell_change",b,null)}c.signal("page_change",0,0,0,0,0);return}if(f<1||Math.floor(f)!=f){throw new Error("invalid page: "+f)}if(f>c.pages){throw new Error("page ("+f+") exceeds pages ("+c.pages+")")}c.disconnect_all();c.page=f;c.cell_to_deal=[];c.deal_id_to_cell={};c.signal("page_change",c.page,c.pages,(c.page-1)*c.cells+1,GBDealNotifier.min(c.page*c.cells,c.deal_ids.length),c.deal_ids.length);for(b=0;b<c.cells;b++){d=(c.page-1)*c.cells+b;if(d<c.deal_ids.length){e=c.deal_ids[d];c.deal_id_to_cell[e]=b;g=c.deals.get_deal(e);c.cell_to_deal[b]=g;c.connect_deal_change(b,g);c.connect_deal_expire(g);c.connect_deal_status_expire(g);c.signal("cell_change",b,g)}else{c.cell_to_deal[b]=null;c.signal("cell_change",b,null)}}for(d=c.page*c.cells;d<(c.page+1)*c.cells&&d<c.deal_ids.length;d++){c.connect_deal_expire(c.deals.get_deal(c.deal_ids[d]));c.connect_deal_status_expire(c.deals.get_deal(c.deal_ids[d]))}},connect_deal_change:function(b,e){var c=this;var d=e.connect("change",function(f){c.signal("cell_change",b,f)});c.connections.push(d)},connect_deal_expire:function(d){var b=this;var c=d.connect("expire",function(g){var e;var f=b.service.get_deal(g.dealID,function(h){e.disconnect();g.load_from_deal(h)},function(h){GBDealNotifier.log("Error getting deal: "+h+" stack: "+h.stack)});e=c.connect("disconnect",function(){f.cancel()})});b.connections.push(c);if(d.expired||d.loading){c.trigger(d)}},connect_deal_status_expire:function(d){var b=this;var c=d.connect("status_expire",function(i){var g;var h=b.service.get_deal_status(i.dealID,function(j){g.disconnect();i.load_from_status(j)},function(j){GBDealNotifier.log("Error getting status: "+j+" stack: "+j.stack)});g=c.connect("disconnect",function(){h.cancel()});var e;var f=b.service.get_deal_asin_status2(i.dealID,function(k){e.disconnect();var m=i.asins;for(var j=0;j<m.length;j++){var l=m[j];if(k[l.asin]){l.status=k[l.asin];l.status.purchaseStatus.expiresDate=new Date(new Date().getTime()+parseInt(l.status.purchaseStatus.msToExpiry,10))}}i._init_asin_statuses();i.signal("change",i)},function(j){GBDealNotifier.log("error with GetDealAsinStatus("+i.dealID+"):"+j)});e=c.connect("disconnect",function(){f.cancel()})});b.connections.push(c);if(d.status.expired&&!(d.expired||d.loading)){c.trigger(d)}},disconnect_all:function(){var b=this;for(var c=0;c<b.connections.length;c++){b.connections[c].disconnect()}b.connections=[]},buy:function(g,f,c){var b=this;var e;if(!b.service.customer_id){var d=b.login_uri;d=d.replace(/%257BdealID%257D/,g.dealID);d=d.replace(/%257Basin%257D/,f);d=d.replace(/%257BmarketplaceID%257D/,b.service.marketplace_id);d=d.replace(/%257Bcategory%257D/,b.filter);window.location=d;return}if(!b.buying[g.dealID]){b.buying[g.dealID]=true;b.service.redeem_deal(g.dealID,f,function(j){delete b.buying[g.dealID];var l=j.deal;if(f!=undefined){var h=l.asins;for(var k=0;k<h.length;k++){var o=h[k];if(o.asin==f){e=o;break}}}else{e=l.asins[0]}var n=e.status.purchaseStatus;var m=n.state;if(j.redeemed==1&&(m==GBDealNotifier.waitInLineStr||m==GBDealNotifier.inCartStr)){g.cartP=new GBDealNotifier.CartPopover(l,e,b.images,c,m);b.closeVarPopover();g.load_from_deal(j.deal);if(j.redeemed==1&&window.dealNotifier){GBDealNotifier.log("Calling dealNotifier.registerDeal("+e.asin+", "+l.dealID+")");dealNotifier.registerDeal(e.asin,g)}}else{g.load_from_deal(j.deal)}},function(h){delete b.buying[g.dealID];GBDealNotifier.log("Error redeeming deal: "+h);if(f!=null){var l=g.asins;if(l==null){g.status.percentClaimed=100}else{for(var j=0;j<l.length;j++){var k=l[j];if(k.asin==f){k.status.percentClaimed=100;break}}}}else{g.status.percentClaimed=100}g.signal("change",g)})}}});GBDealNotifier.DOM={set_attributes:function(e,c){for(var b in c){if(b=="style"){e.style.cssText=c[b]}else{var d={"class":"className",checked:"defaultChecked",usemap:"useMap","for":"htmlFor",readonly:"readOnly",colspan:"colSpan",bgcolor:"bgColor",cellspacing:"cellSpacing",cellpadding:"cellPadding",valign:"vAlign",nowrap:"noWrap"}[b]||b;e[d]=c[b]}}},el:function(e,b,c){var d=document.createElement(e);if(b){GBDealNotifier.DOM.set_attributes(d,b)}if(c){this.appendChildren(d,c)}return d},img:function(b){b=b||{};b.border=b.border||0;return this.el("img",b)},div:function(b,c){return this.el("div",b,c)},span:function(b,c){return this.el("span",b,c)},p:function(b,c){return this.el("p",b,c)},a:function(b,c){return this.el("a",b,c)},table:function(b,c){if(!b){b={}}b.cellpadding=b.cellpadding||0;b.cellspacing=b.cellspacing||0;b.border=b.border||0;return this.el("table",b,[this.el("tbody",null,c)])},tr:function(b,c){return this.el("tr",b,c)},td:function(b,c){return this.el("td",b,c)},td_nowrap:function(b,c){return this.el("td",b,[this.span({style:"white-space:nowrap"},c)])},br:function(b,c){return this.el("br",b,c)},hr:function(b){return this.el("hr")},select:function(b,c){return this.el("select",b,c)},option:function(b,c){return this.el("option",b,c)},appendChildren:function(d,c){for(var b=0;b<c.length;b++){var e=c[b];if(typeof e=="string"||typeof e=="number"){e=this.text(e)}else{if(e instanceof Array){this.appendChildren(d,e);continue}else{if(e===null||e===undefined){continue}}}d.appendChild(e)}},clearChildren:function(b){while(b.firstChild){b.removeChild(b.firstChild)}},replaceChildren:function(c,b){this.clearChildren(c);this.appendChildren.call(this,c,b)},text:function(b){return document.createTextNode(b)}};GBDealNotifier.Widget={};GBDealNotifier.Widget.preload_img=function(b){if(!GBDealNotifier.Widget.preload_img.div){GBDealNotifier.Widget.preload_img.div=GBDealNotifier.DOM.div({style:"display:none"})}GBDealNotifier.Widget.preload_img.div.appendChild(GBDealNotifier.DOM.img({src:b}))};GBDealNotifier.clock={signals:["tick"]};GBDealNotifier.Signal.init(GBDealNotifier.clock);GBDealNotifier.clock.tick=function(){GBDealNotifier.clock.signal("tick")};window.setInterval(GBDealNotifier.clock.tick,250);GBDealNotifier.Timer=function(d,f,e){var c={};c.t=d;c.noHours=e;var b={};c.onTimeoutFunction=null;c.setOnTimeoutFunction=function(g){c.onTimeoutFunction=g};c.update=function(){var i=GBDealNotifier.max(c.t.getTime()-new Date().getTime(),0);if(i<=0){c.disconnect();if(c.onTimeoutFunction!=null){c.onTimeoutFunction()}}var n=Math.floor(i/(60*60*1000));if(n<10){n="0"+n}var g=Math.floor(i/(60*1000)%60);if(g<10&&!c.noHours){g="0"+g}var l=Math.floor(i/(1000)%60);if(l<10){l="0"+l}var k=":";var j=":";var o="";if(gbResources.getCustomerData("realm")=="FR"){k="h ";j="min ";o="s"}c.span=GBDealNotifier.DOM.span(b);if(c.noHours){c.span.innerHTML=g+j+l}else{c.span.innerHTML=n+k+g+j+l+o}};c.disconnect=function(){c.cx.disconnect()};c.cx=GBDealNotifier.clock.connect("tick",c.update);c.update();return c};GBDealNotifier.CheckoutTimer=function(c,d){var b={};b.span=GBDealNotifier.DOM.span();b.t=c;b.onTimeoutFunction=null;b.setOnTimeoutFunction=function(e){b.onTimeoutFunction=e};b.update=function(){var i=GBDealNotifier.max(b.t.getTime()-new Date().getTime(),0);if(i<=0){b.disconnect();if(b.onTimeoutFunction!=null){b.onTimeoutFunction()}return}var g=Math.floor(i/(60*1000)%60);if(g<10&&d){g="0"+g}var m=Math.floor(i/(1000)%60);if(m<10&&d){m="0"+m}var k=" "+gbResources.getString("gbd_minutes")+" ";var l=" "+gbResources.getString("gbd_seconds")+" ";if(d){var f={US:":",UK:":",DE:":",FR:"m",JP:":",CN:":"};var j=gbResources.getCustomerData("realm");var h=":";if(f[j]){h=f[j]}k='<span class="timeleft-large">'+h+"</span>";l=""}var e='<span class="timeleft-large">'+g+"</span>"+k+'<span class="timeleft-large">'+m+"</span>"+l;b.span.innerHTML=e};b.disconnect=function(){b.cx.disconnect()};b.cx=GBDealNotifier.clock.connect("tick",b.update);b.update();return b};GBDealNotifier.truncate_text=function(b){if(b.scrollHeight>b.clientHeight||b.scrollWidth>b.clientWidth){b.title=b.innerHTML}while(b.scrollHeight>b.clientHeight||b.scrollWidth>b.clientWidth){b.innerHTML=b.innerHTML.replace(/\s*\S{0,10}$/,"...")}};GBDealNotifier.truncate_description=function(c,b){var d="";var g=c.innerHTML;if(g==null){if(typeof(c)=="string"){g=c;d=c}else{return""}}if(g.length>b){var f=g.substr(0,b);var e=f.split(" ");e[e.length-1]="";d=e.join(" ");d=d.replace(/[^\w\d]*$/,"");d=d.substr(0,d.length-1)+"...";c.title=c.innerHTML;c.innerHTML=d}else{d=g}return d};GBDealNotifier.help=function(c){var e;var b;var d;e=GBDealNotifier.DOM.div(null,[b=GBDealNotifier.DOM.img({src:c})]);GBDealNotifier.popoverTrigger(b,"amazonPopoverTrigger",{showOnHover:true,showCloseButton:false,location:["left","bottom"],width:300,literalContent:window.gbResources.getString("gbd_ld_help")});return e};GBDealNotifier.CombinationGenerator=GBDealNotifier.Class({__init__:function(g,f){var e=this;e.a=new Array();e.n=null;e.r=null;if(f>g){GBDealNotifier.log("ERROR: r > n");return}if(g<1){GBDealNotifier.log("ERROR: n < 1");return}e.n=g;e.r=f;e.a=new Array(f);var c=e.getFactorial(g);var d=e.getFactorial(f);var b=e.getFactorial(g-f);e.total=c/(d*b);e.reset()},reset:function(){var b=this;for(var c=0;c<b.a.length;c++){b.a[c]=c}b.numLeft=b.total},getNumLeft:function(){var b=this;return b.numLeft},hasMore:function(){var b=this;if(b.numLeft==0){return false}return true},getTotal:function(){var b=this;return b.total},getFactorial:function(e){var b=this;var c=1;for(var d=e;d>1;d--){c*=d}return c},getNext:function(){var b=this;if(b.numLeft==b.total){b.numLeft-=1;return b.a}var d=b.r-1;while(b.a[d]==b.n-b.r+d){d--}b.a[d]=b.a[d]+1;for(var c=d+1;c<b.r;c++){b.a[c]=b.a[d]+c-d}b.numLeft-=1;return b.a}});GBDealNotifier.PStatus=GBDealNotifier.Class({__init__:function(f){var c=this;c.deal=f;c.widget=f.widget;c.popover=f.popover;c.stateAsins={};for(var d=0;d<c.deal.asins.length;d++){var e=c.deal.asins[d];var b=GBDealNotifier.getPurchaseState(f,e);if(c.stateAsins[b]==undefined){c.stateAsins[b]=[]}c.stateAsins[b].push(e)}if(c.stateAsins[GBDealNotifier.inCartStr]){c.stateAsins[GBDealNotifier.inCartStr].sort(c.sortByAsinTimes)}if(c.stateAsins[GBDealNotifier.pendingAtcStr]){c.stateAsins[GBDealNotifier.pendingAtcStr].sort(c.sortByAsinTimes)}},sortByAsinTimes:function(e,d){var c=e.status.purchaseStatus.expiresDate;var f=d.status.purchaseStatus.expiresDate;return c-f},getCount:function(d,b){var c=this;var e=new Date();var h=0;if(c.stateAsins[d]&&c.stateAsins[d].length){for(var g=0;g<c.stateAsins[d].length;g++){var f=c.stateAsins[d][g].status.purchaseStatus.expiresDate;if(f==undefined){f=e}if(b&&f.getTime()>e.getTime()){h++}else{if(!b){h++}}}}return h},getTime:function(g,f){var b=this;var c=new Date();if(b.stateAsins[f]){for(var e=0;e<b.stateAsins[f].length;e++){var d=b.stateAsins[f][e].status.purchaseStatus.expiresDate;if(g!=undefined){if(b.stateAsins[f][e].asin==g){return d}}else{if(d.getTime()>c.getTime()){b.asin=b.stateAsins[f][e];return d}}}}return null},getTimerMessage:function(e,h,d){var j=this;var g=null;if(e!=undefined&&e!=null){j.asinString=e}var b=GBDealNotifier.inCartStr;if(d){b=GBDealNotifier.pendingAtcStr}var i=j.getTime(j.asinString,b);var c=GBDealNotifier.Timer(i,null,true);if(d){g=GBDealNotifier.DOM.div({"class":"status_msg_content"},[gbResources.getString("gbd_deal_atc_time_part1")+" ",GBDealNotifier.DOM.span({"class":"status_timer"},[c.span])," "+gbResources.getString("gbd_deal_atc_time_part2")?gbResources.getString("gbd_deal_atc_time_part2"):""])}else{var f=gbResources.getString("gbd_check_out_within_time_part2_single")!="null"?gbResources.getString("gbd_check_out_within_time_part2_single"):"";if(h!=null&&h>1){f=gbResources.getString("gbd_check_out_within_time_part2_plural")!="null"?gbResources.getString("gbd_check_out_within_time_part2_plural"):""}g=GBDealNotifier.DOM.div({"class":"status_msg_content"},[gbResources.getString("gbd_check_out_within_time_part1")+" ",GBDealNotifier.DOM.span({"class":"status_timer"},[c.span])," "+f])}return g},getItemMsg:function(e,g){var c=this;var b=window.gbResources.getString("gbd_deal_in_cart");var d=window.gbResources.getString("gbd_all_options_in_cart");if(g=="wait"){b=window.gbResources.getString("gbd_you_are_waitlisted");d=window.gbResources.getString("gbd_all_are_waitlisted")}var f=GBDealNotifier.DOM.span({"class":"item_msg"},[b]);if(c.deal.asins.length>1){var h=null;if(e>1&&e==c.deal.asins.length){h=d}else{if(e==1){h=window.gbResources.getString("gbd_1_option_in_cart");if(g=="wait"){h=window.gbResources.getString("gbd_1_option_waitlisted")}}else{if(e>1){h=window.gbResources.getString("gbd_num_options_in_cart",{num:e});if(g=="wait"){h=window.gbResources.getString("gbd_num_options_in_waitlist",{num:e})}}}}a(f).html(h)}return f},getMixedItemMsg:function(i,f){var j=this;var g=GBDealNotifier.DOM.span({"class":"item_msg_normal"},[]);var h=GBDealNotifier.DOM.span({},[GBDealNotifier.DOM.span({style:"font-weight:bold;"},[i])," "+window.gbResources.getString("gbd_in_cart")+" "]);var d=GBDealNotifier.DOM.span({},[GBDealNotifier.DOM.span({style:"font-weight:bold;"},[f])," "+window.gbResources.getString("gbd_on_waitlist")]);var c=j.getTime(null,GBDealNotifier.inCartStr);var b=GBDealNotifier.Timer(c,null,true);var e=GBDealNotifier.DOM.span({"class":"timer"},[GBDealNotifier.DOM.span({style:"font-color:#666666 !important;"},[window.gbResources.getString("gbd_check_out_in")+" "]),GBDealNotifier.DOM.span({"class":"status_timer"},[b.span])]);GBDealNotifier.DOM.appendChildren(g,[h,e,GBDealNotifier.DOM.br(),d]);return g},showBuying:function(){var b=this;GBDealNotifier.DOM.replaceChildren(b.buyButtonContainer,[GBDealNotifier.DOM.img({id:"buying-"+b.deal.dealID,alt:window.gbResources.getString("csld-checking_deal_status"),style:"display: inline;",src:gbResources.getImage("spinner")}),GBDealNotifier.DOM.span({style:"color: #E68221;font-weight: bold;font-size: 10px;"},[window.gbResources.getString("csld-checking_deal_status_alt")])]);b.buy_button.onclick=null},getContent:function(){var i=this;var e=i.getCount(GBDealNotifier.inCartStr,false);var g=i.getCount(GBDealNotifier.inCartStr,true);var j=i.getCount(GBDealNotifier.waitInLineStr,false);var b=i.getCount(GBDealNotifier.pendingAtcStr,true);var h=i.getCount(GBDealNotifier.pendingAtcStr,false);if(b>0){i.buy_button=GBDealNotifier.DOM.img({style:"cursor:pointer;display: inline;",src:gbResources.getImage("add_to_cart")});i.buyButtonContainer=GBDealNotifier.DOM.div({style:'opacity:1.0;filter:"alpha(opacity=100)"cursor:pointer'},[i.buy_button]);i.buy_button.onclick=function(k){if(k){k.stopPropagation();k.preventDefault()}i.widget.cx.buy(i.deal,i.asin.asin,true);i.showBuying();return false};var d=i.getTimerMessage(null,b,true);if(GBDealNotifier.isPrimeEligible(i.deal)){if(gbResources.getCustomerData("realm")=="US"||(gbResources.getCustomerData("realm")!="US"&&gbResources.getCustomerData("isPrimeMember"))){i.deal.prime=GBDealNotifier.DOM.span({style:"display:block; position:absolute; left: 115px;"},[GBDealNotifier.DOM.img({alt:window.gbResources.getString("csld-prime_eligible_alt"),id:"prime-badge-"+i.deal.dealID,style:"display: inline;",src:gbResources.getImage("prime")})])}}return GBDealNotifier.DOM.div({style:"position:relative;"},[i.deal.prime,GBDealNotifier.DOM.div({style:"position:relative;"},[i.buyButtonContainer,d])])}else{if(e==0&&j==0&&h==0){return null}else{if(g==0&&j==0){return GBDealNotifier.DOM.div({"class":"status_content"},[GBDealNotifier.DOM.img({id:"buying-"+i.deal.dealID,alt:window.gbResources.getString("csld-checking_deal_status"),style:"display: inline;",src:gbResources.getImage("spinner")}),GBDealNotifier.DOM.span({style:"color: #E68221;font-weight: bold;font-size: 10px;"},[window.gbResources.getString("csld-checking_deal_status_alt")])])}}}var f=null;var d=null;if(g>0&&j==0){f=i.getItemMsg(g,"cart");d=i.getTimerMessage(null,g,false)}else{if(j>0&&g==0){f=i.getItemMsg(j,"wait")}else{f=i.getMixedItemMsg(g,j)}}if(i.deal.asins.length>1&&!i.deal.status.ended){var c=null;c=GBDealNotifier.DOM.span({"class":"options_link"},[window.gbResources.getString("gbd_select_more_options")]);if(!i.popOver){i.popOver=new GBDealNotifier.VariationPopover(c,i.deal,i.widget.cx)}}return GBDealNotifier.DOM.div({"class":"status_content"},[f,GBDealNotifier.DOM.br(),d,c])}});GBDealNotifier.CartPopover=GBDealNotifier.Class({__init__:function(g,f,h,b,d){var l=this;l.deal=g;l.asin=f;l.waitlist=b;l.state=d;l.popover=l.getPopoverDiv();var c=835;var k=250;var j=true;var e=window.gbResources.getString("gbd_close_and_continue_shopping");if(l.state==GBDealNotifier.waitInLineStr){c=410;e=null;j=false}var i={showCloseButton:true,width:c,height:k,modal:j,closeText:e,closeEventInclude:"CLICK_OUTSIDE",location:"centered",locationAlign:"middle",literalContent:l.popover,onHide:function(){l.onHide()}};if(typeof(amznJQ)==="object"){amznJQ.available("popover",function(){l.pop=a.AmazonPopover.displayPopover(i)})}else{l.pop=a.AmazonPopover.displayPopover(i)}if(l.timer){l.timer.setOnTimeoutFunction(function(){if(l.pop){l.pop.close()}})}},getPopoverDiv:function(){var k=this;var j="background:url("+gbResources.getImage("sprite_site_wide")+") -30px -189px;";var f=window.gbResources.getString("gbd_1_deal_to_cart");var g="";if(k.state==GBDealNotifier.waitInLineStr){f=window.gbResources.getString("gbd_joined_waitlist");g="font-size: 15px; top:-3px; left:23px;";j="background:url("+gbResources.getImage("sprite_site_wide")+") -139px -189px; height: 20px; width: 20px;"}var d=null;if(gbResources.getCustomerData("realm")=="DE"){d="font-size: 15px !important;"}var b=GBDealNotifier.DOM.br();var i=null;var c=null;var e="width: 280px;";var h="image_title_price";if(k.state==GBDealNotifier.waitInLineStr){h="image_title_price_waitlist";c=k.get_inner_message();e="width: 410px;";b=null}else{i=k.get_timer_atc_table()}return GBDealNotifier.DOM.div({},[GBDealNotifier.DOM.div({style:"position:relative;"},[GBDealNotifier.DOM.div({"class":"greencheck_img",style:j},[GBDealNotifier.DOM.span({"class":"cart-popover-label",style:g+d},[f])])]),b,GBDealNotifier.DOM.table({"class":"cart-popover-table"},[GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td({"class":h,style:e},[k.get_image_title_price_table(),]),i]),c])])},get_position_chance:function(){var o=this;var b=null;if(o.asin.status.purchaseStatus.waitListStatus==undefined||o.asin.status.purchaseStatus.waitListStatus==null){return null}else{var k=o.asin.status.purchaseStatus.waitListStatus;var l=k.inCartIndicator;var e=k.position;if(l==undefined||l==null||e==undefined||e==null){return null}}if(o.asin.status.purchaseStatus.waitListStatus!=undefined){var d=o.asin.status.purchaseStatus.waitListStatus.inCartIndicator;var e=o.asin.status.purchaseStatus.waitListStatus.position;if(e>500){e="500+"}else{e=a("<span />").html(window.gbResources.getString("gbd_position_num",{num:e}));e=e[0]}var c=GBDealNotifier.DOM.td({"class":"pc_value"},[e]);if(gbResources.getCustomerData("realm")=="CN"){a(c).css("font-weight","")}var j=GBDealNotifier.DOM.td({"class":"pc_label"},[window.gbResources.getString("gbd_place_on_waitlist")]);var h=GBDealNotifier.DOM.td({"class":"pc_value"},[window.gbResources.getString("gbd_"+d.toLowerCase())]);var m=GBDealNotifier.DOM.td({"class":"pc_label"},[window.gbResources.getString("gbd_chance_at_deal")]);var f;var n;var g;var i;if(gbResources.getCustomerData("realm")=="CN"){f=j;n=c;g=m;i=h}else{f=c;n=j;g=h;i=m}b=GBDealNotifier.DOM.div({"class":"waitlist_position_chance"},[GBDealNotifier.DOM.br(),GBDealNotifier.DOM.table({},[GBDealNotifier.DOM.tr({},[f,GBDealNotifier.DOM.td(null,["\xA0"]),n]),GBDealNotifier.DOM.tr({},[g,GBDealNotifier.DOM.td(null,["\xA0"]),i])])])}return b},get_inner_message:function(){var c=this;var d=GBDealNotifier.DOM.span({"class":"waitlist_message"},[window.gbResources.getString("gbd_continue_shopping_alert_msg")]);if(c.state==GBDealNotifier.waitInLineStr&&!c.waitlist){a(d).html(window.gbResources.getString("gbd_forced_waitlist_msg"))}var f="background:url("+gbResources.getImage("sprite_site_wide")+") -117px -189px;";var b=GBDealNotifier.DOM.div({"class":"bubble",style:f},[" "]);var e=GBDealNotifier.DOM.a({href:"#","class":"ap_custom_close"},[GBDealNotifier.DOM.img({alt:window.gbResources.getString("gbd_continue_shopping"),style:"display: inline;",src:gbResources.getImage("continue_shopping")})]);return GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td({},[GBDealNotifier.DOM.table({"class":"inner_message_waitlist"},[GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td({style:"padding: 8px 0 8px 8px;"},[b]),GBDealNotifier.DOM.td({style:"padding: 8px;"},[d])]),GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td({style:"padding: 0 8px 8px;",colSpan:2},[e])])])])])},get_timer_atc_table:function(){var b=this;return GBDealNotifier.DOM.td({},[GBDealNotifier.DOM.table({"class":"inner-cart-popover-table"},[GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td({style:"text-align:left; padding:10px;"},[GBDealNotifier.DOM.a({href:"/gp/cart/view.html/ref=gno_cart"},[GBDealNotifier.DOM.img({alt:window.gbResources.getString("gbd_view_cart_proceed"),style:"display: inline;",src:gbResources.getImage("view_cart_proceed")})]),b.get_timer_message_table()])])])])},get_timer_message_table:function(){var b=this;var c=null;if(window.gbResources.getFeature("pc_deal_notifier")&&window.gbResources.getFeature("pc_deal_notifier")!="C"){c=window.gbResources.getString("gbd_time_before_alert_msg",{time:10})}return GBDealNotifier.DOM.table({"class":"inner-msg"},[GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td({style:"padding: 8px 8px 0px;"},[GBDealNotifier.DOM.div({"class":"alert",style:"background:url("+gbResources.getImage("sprite_site_wide")+");"},[])]),GBDealNotifier.DOM.td({"class":"msgtitle"},[window.gbResources.getString("gbd_checkout_within")])]),GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td(null,[]),GBDealNotifier.DOM.td({"class":"timeleft"},[b.timeRemaining()])]),GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td(null,[]),GBDealNotifier.DOM.td({"class":"smallprint",style:"width:100%;"},[c])])])},get_image_title_price_table:function(){var l=this;var b=l.asin.imageURL;b=b=GBDealNotifier.resizeImage(b,85);var g=null;if(l.deal.detail.title){g=GBDealNotifier.truncate_description(l.deal.detail.title,65)}var e=null;if(l.asin.listPrice){e=GBDealNotifier.Price.format(l.asin.listPrice)}else{if(l.asin.ourPrice){e=GBDealNotifier.Price.format(l.asin.ourPrice)}}var j=GBDealNotifier.DOM.br();var i=window.gbResources.getString("csld-multi-cat-list_price")+" ";if(gbResources.getCustomerData("realm")=="UK"){i=window.gbResources.getString("csld-multi-cat-price")+" "}var c=window.gbResources.getString("csld-deal_price")+" ";var f=null;if(l.state==GBDealNotifier.waitInLineStr){j=" ";c=null;i=null;f=l.get_position_chance()}var k=null;if(l.state==GBDealNotifier.waitInLineStr){k="width:247px"}var d="";if(e){d=[GBDealNotifier.DOM.span({"class":"cart-popover-listprice"},[i]),GBDealNotifier.DOM.span({"class":"cart-popover-prevprice"},[e])]}var h=GBDealNotifier.DOM.span({style:"white-space:nowrap"},[GBDealNotifier.Price.format(l.asin.dealPrice)]);return GBDealNotifier.DOM.table({style:"padding-top:10px;"},[GBDealNotifier.DOM.tr({},[GBDealNotifier.DOM.td({style:"padding-right: 10px; vertical-align: top;"},[GBDealNotifier.DOM.img({alt:window.gbResources.getString("gbd_deal_image"),style:"display: inline",src:b})]),GBDealNotifier.DOM.td({style:"vertical-align: top;"+k},[GBDealNotifier.DOM.span({"class":"cart-popover-asintitle"},[g]),GBDealNotifier.DOM.p(null,[]),d,j,GBDealNotifier.DOM.span({"class":"cart-popover-dealprice"},[c,h]),f])])])},timeRemaining:function(){var b=this;b.timer_div=GBDealNotifier.DOM.div({"class":"timeleft"},[]);b.updateTimeRemaining();return b.timer_div},updateTimeRemaining:function(){var c=this;var e=c.deal;var d=c.asin;if(c.timer){c.timer.disconnect()}if(e.status.ended){c.timer=null}else{var f=parseInt(d.status.purchaseStatus.msToExpiry,10);var b=new Date();b.setTime(b.getTime()+f);c.timer=GBDealNotifier.CheckoutTimer(b,false);GBDealNotifier.DOM.replaceChildren(c.timer_div,[c.timer.span])}},onHide:function(){var b=this;if(b.timer){b.timer.disconnect()}}});GBDealNotifier.VariationPopover=GBDealNotifier.Class({__init__:function(e,f,c){var d=this;d.deal=f;d.cx=c;d.dropDownOptions={};d.currentSelections={};var b=0;var g=0;if(d.cx.name=="GBLD_WIDGET"){b=-137;g=-156}else{if(d.cx.cells==1){b=-174;g=-197}else{b=-79;g=-221}}GBDealNotifier.popoverTrigger(e,"amazonPopoverTrigger",{showOnHover:false,locationAlign:"middle",location:"auto",locationOffset:[b,g],literalContent:" ",closeEventInclude:"CLICK_OUTSIDE",onShow:function(h){d.onShow(h)},onHide:function(){d.onHide()},title:'<span style="color: #E47911;">'+window.gbResources.getString("csld-deal_options")+"</span>",closeText:window.gbResources.getString("csld-close")})},onShow:function(e){var c=this;c.cx.setVarPopCloseFunction(e.close);c.selection={};c.selectors={};c.selection_span={};c.selectionDropDownElements={};c.asinsForSelection();c.allValidCombinations={};c.getAllCombinations();var b=e.find(".ap_sub_content");if(b.length==0){b=e.find(".ap_content")}var f=c.progressBar();var d=GBDealNotifier.DOM.div({style:"padding-top: 4px;"},[GBDealNotifier.DOM.a({href:window.gbResources.getString("csld-restrictions_link"),style:"font-size: 11px; text-decoration: none;"},[window.gbResources.getString("csld-restrictions_apply")])]);if(c.marketplaceID=="US"||c.marketplaceID=="UK"){d=GBDealNotifier.DOM.div({style:"position:relative; left:0px; font-family: verdana;"},[window.gbResources.getString("gbd_ld_rules")])}b.empty().append(GBDealNotifier.DOM.table({width:"430"},[GBDealNotifier.DOM.tr({valign:"top"},[GBDealNotifier.DOM.td({width:"120"},[c.image(),f,c.timeRemaining()]),GBDealNotifier.DOM.td({width:"10"}),GBDealNotifier.DOM.td({},[c.title(),c.selector(),c.price(),GBDealNotifier.DOM.div({style:"margin-top:10px; position: relative;",height:"22"},[c.buyButton(),c.statusBox(),GBDealNotifier.DOM.br(),d])])])]));c.container=b;c.change_cx=c.deal.connect("change",c,"deal_change")},getSelectionCombinations:function(g,j){var h=new Array();if(j==0){g.length}var b=new GBDealNotifier.CombinationGenerator(g.length,j);var f="";var d=[];while(b.hasMore()){f="";h=b.getNext();var c=[];for(var e=0;e<h.length;e++){c.push(g[h[e]])}f=c.join(";");d.push(f)}return d},onHide:function(){var b=this;b.timer.cx.disconnect();b.change_cx.disconnect()},deal_change:function(){var b=this;b.asinsForSelection();b.update()},update:function(){var b=this;b.updateImage();b.updatePrice();b.updateSelectionBoxes();b.updateBuyButton();b.updateStatusBox();b.updateProgressBar();b.updateTimeRemaining()},image:function(){var b=this;b.img=GBDealNotifier.DOM.img();b.updateImage();return GBDealNotifier.DOM.div(null,[b.img])},updateImage:function(){var b=this;var c=b.imageURLForCurrentSelection();if(!c){c=gbResources.getImage("no_image")||"http://g-ecx.images-amazon.com/images/G/01/x-site/icons/no-img-sm.gif"}else{c=c.replace(/\.((_.*_)\.)?(gif|jpg)$/,".$2_AA120_.$3")}b.img.src=c},imageURLForCurrentSelection:function(){var d=this;var f;if(d.selectedAsin){return d.selectedAsin.imageURL}var e=null;for(f=0;f<d.selectedAsins.length;f++){if(e){if(e!=d.selectedAsins[f].imageURL){e=null;break}}else{e=d.selectedAsins[f].imageURL}}if(e){return e}for(var c in d.selection){var b=d.selection[c];e=d.imageURLForSelection(c,b);if(e){return e}}return d.deal.detail.imageAsin},imageURLForSelection:function(d,c){var b=this;var f;for(var e=0;e<b.deal.asins.length;e++){var g=b.deal.asins[e];if(g.variationData[d]!=c){continue}if(f){if(f!=g.imageURL){return null}}else{f=g.imageURL}}return f},progressBar:function(){var b=this;b.progressBarInner=GBDealNotifier.DOM.div({style:"position:absolute;background-color:#C9D7E4;height:19px;"});b.progressBarText=GBDealNotifier.DOM.div({style:"font-size: 9px;overflow:hidden;position:absolute;padding:2px 0 0 0;text-align:center;vertical-align:middle;width:100%"});b.progressBarOuter=GBDealNotifier.DOM.div({style:"border:1px solid #C9D7E4;height: 19px;position: relative;margin-top:10px;width: 118px;"},[b.progressBarInner,b.progressBarText]);b.updateProgressBar();return b.progressBarOuter},updateProgressBar:function(){var b=this;if(b.deal.limitedQuantity){if(b.selectedAsins.length==b.deal.asins.length){b.showPercentClaimed(b.deal.status.percentClaimed)}else{if(b.selectedAsin){b.showPercentClaimed(b.selectedAsin.status.offerServiceSoldOut?100:b.selectedAsin.status.percentClaimed)}else{b.showPercentClaimed(null)}}}else{b.showPercentClaimed(null)}},showPercentClaimed:function(c){var b=this;c=Math.round(c);if(c!=null){b.progressBarOuter.style.visibility="";b.progressBarInner.style.width=c+"%";b.progressBarText.innerHTML=window.gbResources.getString("gbd_percent_now_claimed",{percent:c})}else{b.progressBarOuter.style.visibility="hidden"}},timeRemaining:function(){var b=this;b.timer_div=GBDealNotifier.DOM.div({style:"font-size:9px;text-align:center; margin-top: 5px;"});b.updateTimeRemaining();return b.timer_div},updateTimeRemaining:function(){var b=this;if(b.timer){b.timer.cx.disconnect()}if(b.deal.status.ended){b.timer_div.innerHTML=window.gbResources.getString("csld-expired_status");b.timer=null}else{var c=b.deal;b.timer=GBDealNotifier.Timer(c.status.endDate);b.timer.span.id="time-remaining-"+c.dealID;b.timer.span.style.fontWeight="bold";GBDealNotifier.DOM.replaceChildren(b.timer_div,[window.gbResources.getString("csld_remaining")+" ",b.timer.span," "+window.gbResources.getString("csld_remaining_part2")])}},title:function(){var b=this;return GBDealNotifier.DOM.span({style:"font-weight:bold"},[b.deal.detail.title])},selector:function(){var b=this;var j=b.deal.asins;b.options={};b.color_images={};for(var d=0;d<j.length;d++){var g=j[d].variationData;for(var c in g){var e=b.options[c];if(e===undefined){b.options[c]=e={}}e[g[c]]=1;if(c=="Color"){b.color_images[c]=j[d].imageURL}}}var h=[];var f=undefined;for(var c in b.options){if(c=="Color"){f=b.dropdownSelector(c)}else{h.push(b.dropdownSelector(c))}}if(f!=undefined){h.push(f)}return GBDealNotifier.DOM.div(null,h)},colorSelector:function(b){},dropdownSelector:function(g){var d=this;var j=[GBDealNotifier.DOM.option(null,[""])];j[0].value="Select";j[0].text=window.gbResources.getString("csld-select");var c=[];for(var h in d.options[g]){c.push(h)}c.sort(d.numOrderAsc);if(d.dropDownOptions[g]==undefined){d.dropDownOptions[g]=[]}for(var f=0;f<c.length;f++){var e=GBDealNotifier.DOM.option(null,[c[f]]);j.push(e);d.dropDownOptions[g].push(e)}var b=d.selectors[g]||GBDealNotifier.DOM.select(null,j);if(!d.selectors[g]){d.selectors[g]=b}d.selectionDropDownElements[g]=b;b.onchange=function(){d.selectionChange(g,d.selectors[g][b.selectedIndex].value,d.selectors[g][b.selectedIndex].text)};d.selection_span[g]=GBDealNotifier.DOM.span({style:"color:#E47911"});return GBDealNotifier.DOM.div({style:"margin-top: 10px"},[GBDealNotifier.DOM.span({style:"font-weight: bold; font-size: 13px;"},[gbResources.getString("csld-common-select_key",{key:g}),d.selection_span[g]]),GBDealNotifier.DOM.br(),b])},isCurrentlyValidOption:function(c,d){var b=this;if(b.validOptions&&b.validOptions[c]&&b.validOptions[c][d]==1){return true}return false},resetAllOtherOptions:function(e){var d=this;for(var c in d.selectionDropDownElements){if(c==e){continue}var b=d.selectionDropDownElements[c];if(b){b.selectedIndex=0;b.onchange()}}},selectionChange:function(d,e,f){var c=this;if(e!="Select"){var b=false;if(!c.isCurrentlyValidOption(d,f)){b=true}c.currentSelections[d]=f;c.selection[d]=f;a(c.selection_span[d]).html(f);if(b){c.resetAllOtherOptions(d)}}else{delete c.currentSelections[d];delete c.selection[d];a(c.selection_span[d]).html("")}c.asinsForSelection();c.updateDropDownStyles(d,f);c.update()},getAllCombinations:function(){var l=this;for(var e=0;e<l.deal.asins.length;e++){var d=l.deal.asins[e];var f=d.variationData;var c=l.getSortedKeys(f);var m=new Array();for(var g=0;g<c.length;g++){var k=c[g];var h=k+":"+f[k];m.push(h)}var b=l.combine(m);for(var g=0;g<b.length;g++){b[g]=b[g].join(";");var j=b[g];if(!l.allValidCombinations[j]){l.allValidCombinations[j]=new Array()}l.allValidCombinations[j].push(d)}}},numOrderAsc:function(d,c){var f=parseInt(d);var e=parseInt(c);if(isNaN(f)&&isNaN(e)){if(d>c){return 1}else{if(d<c){return -1}else{return 0}}}else{if(isNaN(f)){return 1}else{if(isNaN(e)){return -1}else{if(f>e){return 1}else{if(f<e){return -1}else{return 0}}}}}},getSortedKeys:function(d){var c=[];for(var b in d){c.push(b)}c.sort();return c},asinsForSelection:function(){var d=this;d.selectedAsins=[];for(var f=0;f<d.deal.asins.length;f++){var g=d.deal.asins[f];var e=true;for(var b in d.selection){if(g.variationData&&g.variationData[b]!=d.selection[b]){e=false;break}}if(e){d.selectedAsins.push(g)}}d.selectedAsins=d.uniqueAsinArray(d.selectedAsins);if(d.selectedAsins.length==1){d.selectedAsin=d.selectedAsins[0];d.selection={};for(var c in d.selectedAsin.variationData){d.selection[c]=d.selectedAsin.variationData[c]}d.updateSelection();if(d.selectedAsin.status.percentClaimed<100&&!d.selectedAsin.offerServiceSoldOut&&!d.deal.status.ended&&d.deal.status.percentClaimed<100){d.available=true}else{d.available=false}}else{d.selectedAsin=null;d.available=false;d.updateSelection()}},uniqueAsinArray:function(g){var k=this;var e={};var l=[];if(!g){return l}for(var f=0;f<g.length;f++){var d=g[f];var b=d.asin;e[b]=d}var c=k.getSortedKeys(e);for(var f=0;f<c.length;f++){var j=c[f];var h=e[j];l.push(h)}return l},updateSelection:function(){var c=this;for(var b in c.selection_span){if(c.selection[b]!=undefined){a(c.selection_span[b]).html(c.selection[b])}else{a(c.selection_span[b]).html("")}}for(var b in c.selectors){c.selectors[b].value=c.selection[b]||"";if(c.selection[b]&&!c.selectors[b].value){for(var d=0;d<c.selectionDropDownElements[b].options.length;d++){if(c.selectionDropDownElements[b].options[d].text==c.selection[b]){c.selectors[b].selectedIndex=d}}}}},updateDropDownStyles:function(g,f){var e=this;e.getValidOptions();for(var d in e.dropDownOptions){for(var c=0;c<e.dropDownOptions[d].length;c++){var b=e.dropDownOptions[d][c];if(b==null){continue}var h=b.value||b.text;if((e.currentSelections.length<=1&&d==g&&h==f)||(e.validOptions[d]&&e.validOptions[d][h]==1)){b.setAttribute("style","color: #000000;");if(!b.value){b.style.setAttribute("color","#000000")}}else{b.setAttribute("style","color: #afafaf;");if(!b.value){b.style.setAttribute("color","#afafaf")}}}}},getValidOptions:function(){var c=this;c.validOptions={};c.selectableAsins=c.getSelectableAsins();for(var b=0;b<c.selectableAsins.length;b++){var d=c.selectableAsins[b];if(d==null){continue}for(var f in d.variationData){var e=d.variationData[f];if(c.validOptions[f]==undefined){c.validOptions[f]={}}c.validOptions[f][e]=1}}},getSelectableAsins:function(){var s=this;var o=[];var f=s.getSortedKeys(s.currentSelections);if(f.length==0){return s.selectedAsins}var t=[];for(var m=0;m<f.length;m++){var r=f[m];var p=s.currentSelections[r];var q=r+":"+p;t.push(q)}var l=f.length;var g=s.getSortedKeys(s.dropDownOptions);var e=g.length;if(l>=e){l=e-1}var d=s.getSelectionCombinations(t,l);var b={};for(var m=0;m<d.length;m++){var r=d[m];var n=s.allValidCombinations[r];if(n&&n.length>0){for(var k=0;k<n.length;k++){var h=n[k];if(h){var c=h.asin;b[c]=h}}}}var f=s.getSortedKeys(b);for(var m=0;m<f.length;m++){var r=f[m];var p=b[r];o.push(p)}return o},price:function(){var b=this;b.priceBlock=GBDealNotifier.DOM.div({style:"margin-top: 10px"});b.updatePrice();return b.priceBlock},updatePrice:function(){var b=this;if(b.selectedAsin){b.updatePriceSingleAsin()}else{if(b.selectedAsins.length>1){b.updatePriceRange()}else{b.updatePriceNoAsins()}}},updatePriceSingleAsin:function(){var p=this;var h=this.selectedAsin;if(h.offerServiceSoldOut||!h.dealPrice||!h.dealPrice.price){p.updatePriceNoAsins();return}var d=h.listPrice;var m=h.ourPrice;var f=h.dealPrice;var n=GBDealNotifier.Price.minus(d,f);var k=GBDealNotifier.Price.minus(m,f);var o=GBDealNotifier.formatPricePercentage(GBDealNotifier.Price.percent_off(d,f));var e=GBDealNotifier.formatPricePercentage(GBDealNotifier.Price.percent_off(m,f));var c=GBDealNotifier.Price.format(d);var j=GBDealNotifier.Price.format(m);var l=GBDealNotifier.Price.format(f);var g=GBDealNotifier.Price.format(n);var b=GBDealNotifier.Price.format(k);var i=[];i.push(GBDealNotifier.DOM.span({id:"list-price-popover",style:"font-size: 11px;color: #666666;text-decoration: line-through;"},[c||j]));i.push(" ");i.push(GBDealNotifier.DOM.span({id:"deal-price-popover",style:"font-size: 13px;color: #990000;"},[l]));i.push(" ");i.push(GBDealNotifier.DOM.span({id:"percent-off-popover",style:"font-size: 11px;color: #990000;"},[window.gbResources.getString("csld-percent_off",{discountPercentage:(o||e)})]));GBDealNotifier.DOM.replaceChildren(p.priceBlock,i)},updatePriceRange:function(){var c=this;var f=null;var b=null;for(var e=0;e<c.selectedAsins.length;e++){var g=c.selectedAsins[e];if(g.status.percentClaimed>=100||g.offerServiceSoldOut||!g.dealPrice||!g.dealPrice.price){continue}var d=parseFloat(g.dealPrice.price);if(!b||d>parseFloat(b.price)){b=g.dealPrice}if(!f||d<parseFloat(f.price)){f=g.dealPrice}}if(!f||!b){c.updatePriceNoAsins()}else{if(f==b){GBDealNotifier.DOM.replaceChildren(c.priceBlock,[GBDealNotifier.DOM.span({style:"color:#900;font-size:13px"},[GBDealNotifier.Price.format(f)])])}else{GBDealNotifier.DOM.replaceChildren(c.priceBlock,[GBDealNotifier.DOM.span({style:"color:#900;font-size:13px"},[GBDealNotifier.Price.format(f),"-",GBDealNotifier.Price.format(b)])])}}},updatePriceNoAsins:function(){var c=this;var d=[];for(var b in c.selection){d.push(GBDealNotifier.DOM.span({style:"font-weight: bold"},[b,": ",GBDealNotifier.DOM.span({style:"color:#B00"},[c.selection[b]])]));d.push(GBDealNotifier.DOM.br())}},updateSelectionBoxes:function(){var c=this;var d=false;if(c.cx.buying[c.deal.dealID]){d=true}for(var e in c.selectors){var b=c.selectors[e];b.disabled=d}},buyButton:function(){var b=this;b.buy_button=GBDealNotifier.DOM.img({style:"cursor:pointer;display: inline;",src:gbResources.getImage("add_to_cart")});b.buyButtonContainer=GBDealNotifier.DOM.div({},b.buy_button);b.updateBuyButton();return b.buyButtonContainer},updateBuyButton:function(){var b=this;if(b.cx.buying[b.deal.dealID]){b.showBuying()}else{b.showBuyButton()}},showBuyButton:function(){var b=this;var e=GBDealNotifier.getPurchaseState(null,b.selectedAsin);var d=null;var c=null;if(b.selectedAsin&&e==GBDealNotifier.waitInLineStr){b.buy_button.src=gbResources.getImage("add_to_cart");b.buy_button.alt=window.gbResources.getString("csld-add_to_cart");b.buy_button.onclick=null;b.buy_button.style.opacity=0.5;b.buy_button.style.cursor="default";b.buy_button.style.filter="alpha(opacity=50)";c=GBDealNotifier.DOM.div({style:"font-weight: bold;font-size: 11px;"},[window.gbResources.getString("gbd_this_option_waitlisted")])}else{if(b.selectedAsin&&e==GBDealNotifier.inCartStr){if(b.selectedAsin.status.purchaseStatus.msToExpiry>0){b.buy_button.src=gbResources.getImage("add_to_cart");b.buy_button.alt=window.gbResources.getString("csld-add_to_cart");b.buy_button.onclick=null;b.buy_button.style.opacity=0.5;b.buy_button.style.cursor="default";b.buy_button.style.filter="alpha(opacity=50)";d=GBDealNotifier.DOM.span({style:"font-weight: bold;font-size: 13px;"},[" "+window.gbResources.getString("gbd_in_your_cart")]);c=b.getStatusContent(false)}else{GBDealNotifier.DOM.replaceChildren(b.buyButtonContainer,[GBDealNotifier.DOM.img({id:"buying-"+b.deal.dealID,alt:window.gbResources.getString("csld-checking_deal_status"),style:"display: inline;",src:gbResources.getImage("spinner")}),GBDealNotifier.DOM.span({style:"color: #E68221;font-weight: bold;font-size: 10px;"},[window.gbResources.getString("csld-checking_deal_status_alt")])]);b.buy_button.onclick=null;return}}else{if(b.selectedAsin&&b.available&&!GBDealNotifier.isClaimed(null,b.selectedAsin)||(e==GBDealNotifier.pendingAtcStr)){if(b.selectedAsin.status.purchaseStatus.msToExpiry>0||b.selectedAsin.status.purchaseStatus.state==GBDealNotifier.expiredStr||b.selectedAsin.status.purchaseStatus.state==GBDealNotifier.availableStr){b.buy_button.src=gbResources.getImage("add_to_cart");b.buy_button.alt=window.gbResources.getString("csld-add_to_cart");b.buy_button.style.opacity=1;b.buy_button.style.filter="alpha(opacity=100)";b.buy_button.style.cursor="pointer";if(e==GBDealNotifier.pendingAtcStr){c=b.getStatusContent(true)}b.buy_button.onclick=function(f){if(f){f.stopPropagation();f.preventDefault()}b.cx.buy(b.deal,b.selectedAsin.asin,false);b.showBuying();b.updateSelectionBoxes();return false}}else{GBDealNotifier.DOM.replaceChildren(b.buyButtonContainer,[GBDealNotifier.DOM.img({id:"buying-"+b.deal.dealID,alt:window.gbResources.getString("csld-checking_deal_status"),style:"display: inline;",src:gbResources.getImage("spinner")}),GBDealNotifier.DOM.span({style:"color: #E68221;font-weight: bold;font-size: 10px;"},[window.gbResources.getString("csld-checking_deal_status_alt")])]);b.buy_button.onclick=null;return}}else{if(b.selectedAsin&&b.selectedAsin.status.percentSoldOut<100&&b.selectedAsin.status.percentClaimed>=100){b.buy_button.src=gbResources.getImage("join_waitlist");b.buy_button.alt=window.gbResources.getString("join_waitlist");if(b.selectedAsin.status.currentlyUnavailable){Deal.DOM.replaceChildren(b.buyButtonContainer,[Deal.DOM.span({style:"position:relative; font-size: 11px; color:#900;"},[window.gbResources.getString("gbd_waitlist_full")])]);b.buy_button.onclick=null;return}else{b.buy_button.style.opacity=1;b.buy_button.style.filter="alpha(opacity=100)";b.buy_button.style.cursor="pointer";b.buy_button.onclick=function(f){if(f){f.stopPropagation();f.preventDefault()}b.cx.buy(b.deal,b.selectedAsin.asin,true);b.showBuying();b.updateSelectionBoxes();return false}}}else{b.buy_button.src=gbResources.getImage("add_to_cart");b.buy_button.alt=window.gbResources.getString("csld-add_to_cart");b.buy_button.onclick=null;b.buy_button.style.opacity=0.5;b.buy_button.style.cursor="default";b.buy_button.style.filter="alpha(opacity=50)"}}}}GBDealNotifier.DOM.replaceChildren(b.buyButtonContainer,[b.buy_button,d,c])},getStatusContent:function(e){var b=this;var d=null;if(b.deal.pStatus==undefined||b.deal.pStatus[b.selectedAsin.asin]==undefined){b.deal.pStatus=[];b.deal.pStatus[b.selectedAsin.asin]=new GBDealNotifier.PStatus(b.deal)}var c=b.deal.pStatus[b.selectedAsin.asin];d=c.getTimerMessage(b.selectedAsin.asin,null,e);return d},showBuying:function(){var b=this;a(b.statusBoxObject).css("padding-left",50);GBDealNotifier.DOM.replaceChildren(b.buyButtonContainer,[GBDealNotifier.DOM.img({id:"buying-"+b.deal.dealID,alt:window.gbResources.getString("csld-checking_deal_status"),style:"display: inline;",src:gbResources.getImage("spinner")}),GBDealNotifier.DOM.span({style:"color: #E68221;font-weight: bold;font-size: 10px;"},[window.gbResources.getString("csld-checking_deal_status_alt")])]);b.buy_button.onclick=null},statusBox:function(){var b=this;b.statusBoxObject=GBDealNotifier.DOM.span({style:"padding-left: 10px; font-weight: bold; font-size: 13px; position: relative; top: -18px; left: 100px;"},GBDealNotifier.DOM.text(""));b.updateStatusBox();return b.statusBoxObject},updateStatusBox:function(){var b=this;var c="";if(b.selectedAsin!=undefined){if(GBDealNotifier.inState(null,b.selectedAsin,GBDealNotifier.claimedStr)){c=window.gbResources.getString("csld-claimed")}else{if(!GBDealNotifier.inState(null,b.selectedAsin,GBDealNotifier.pendingAtcStr)&&!GBDealNotifier.inState(null,b.selectedAsin,GBDealNotifier.inCartStr)&&!GBDealNotifier.inState(null,b.selectedAsin,GBDealNotifier.waitInLineStr)&&!GBDealNotifier.inState(null,b.selectedAsin,GBDealNotifier.availableStr)&&!GBDealNotifier.inState(null,b.selectedAsin,GBDealNotifier.expiredStr)&&!b.available){c=window.gbResources.getString("csld-sold_out")}}}b.statusBoxObject.innerHTML=c},combine:function(b){var e=function(k,i,f,h){if(k==0){if(f.length>0){h[h.length]=f}return}for(var g=0;g<i.length;g++){e(k-1,i.slice(g+1),f.concat([i[g]]),h)}return};var d=[];for(var c=0;c<b.length;c++){e(c,b,[],d)}d.push(b);return d}});if(window.P&&window.P.AUI_BUILD_DATE){window.gbRegistered=window.gbRegistered||{};if(!window.gbRegistered.gbDealNotifierScope){window.gbRegistered.gbDealNotifierScope=true;P.register("gbDealNotifierScope",function(){return window.GBDealNotifier})}}};if(window.P&&window.P.AUI_BUILD_DATE){P.when("A","dealResources").execute(function(a){registerDealScope(a.$)})}else{if(window.amznJQ&&typeof amznJQ==="object"){amznJQ.onReady("jQuery",function(){registerDealScope(window.jQuery)})}}};
var registerDealNotifierUtil=function(f,c,b){var e;var d=GBDealNotifier.Class({__init__:function(j){var g=this;g.displayingData=j.displayingData;g.onClickFunction=j.onClickFunction;g.buyFunction=j.buyFunction;g.notifier=j.notifier;g.watchDealDisplayingData=j.watchDealDisplayingData;g.timers={};g.addToCartButtons={};g.refTagPrefix="xs_gb_ld_tck_";g.headerStrings={};g.setHeaderStrings();g.asinCategoryData={};for(var h in GBDealNotifier.stateAlertsEnum){g.asinCategoryData[GBDealNotifier.stateAlertsEnum[h]]=[]}g.categorizeAsins();g.watchDealContentUtil=new a({watchDealDisplayingData:g.watchDealDisplayingData,dealContentUtil:g})},setHeaderStrings:function(){this.headerStrings[GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON]={singular:gbResources.getString("dn-begin_checking_out_singular"),plural:gbResources.getString("dn-begin_checking_out_plural")};this.headerStrings[GBDealNotifier.stateAlertsEnum.ATC_EXPIRED]={singular:gbResources.getString("dn-time_ran_out_on_singular"),plural:gbResources.getString("dn-time_ran_out_on_plural")};this.headerStrings[GBDealNotifier.stateAlertsEnum.WL_PATC]={singular:gbResources.getString("dn-deal_is_avail_singular"),plural:gbResources.getString("dn-deal_is_avail_plural")};this.headerStrings[GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED]={singular:gbResources.getString("dn-time_to_claim_ran_out_singular"),plural:gbResources.getString("dn-time_to_claim_ran_out_plural")};this.headerStrings[GBDealNotifier.stateAlertsEnum.WL_SOLD_OUT]={singular:gbResources.getString("dn-deal_sold_out_singular"),plural:gbResources.getString("dn-deal_sold_out_plural")};this.headerStrings[GBDealNotifier.stateAlertsEnum.WL_DEAL_ENDED]={singular:gbResources.getString("dn-deal_has_ended_singular"),plural:gbResources.getString("dn-deal_has_ended_plural")};this.headerStrings[GBDealNotifier.watchDealStates.WD_LIVE]={singular:gbResources.getString("dn_watched_deal_starting_singular"),plural:gbResources.getString("dn_watched_deal_starting_plural")};this.headerStrings[GBDealNotifier.watchDealStates.WD_CANCELLED]={singular:gbResources.getString("dn_watched_deal_cancelled_singular"),plural:gbResources.getString("dn_watched_deal_cancelled_plural")}},onClickA:function(h,j){var g=this;var k=GBDealNotifier.DOM.a({href:"#"},j);f(k).click(function(){if(g.onClickFunction){g.onClickFunction()}f(window.location).attr("href",h);return false});return k},categorizeAsins:function(){var g=this;for(var m in g.displayingData){var k=g.displayingData[m];var l=k.deal;var j=k.stateAlertEnum;var h=GBDealNotifier.findDealAsin(m,l);if(h==null){continue}if(g.asinCategoryData[j]){g.asinCategoryData[j].push({dealAsin:h,deal:l})}else{g.log("Unrecognized stateAlertEnum found: "+j);continue}}},getVariationString:function(h){var k="";var g=[];if(h.variationData){for(var j in h.variationData){g.push(h.variationData[j])}}if(g.length>0){k="("+g.join(", ")+")"}return k},getUrl:function(g){return"/gp/product/"+g.asin+"/ref="+this.refTagPrefix+g.dealID},getViewMoreUrl:function(h,m){var j="";var l="/ref=";if(h){j=h.dealID}var g="";if(gbResources.getCustomerData("realm")=="US"){g="/gp/goldbox/all-deals"}else{g=m.detail.buyBoxUrl;if(g.match(/\/$/)){l="ref="}}var k="";if(g.indexOf("?")!==-1){g=g.split("?");l="/ref=";k=g[0]+l+this.refTagPrefix+j+"?"+g[1]}else{k=g+l+this.refTagPrefix+j}return k},getTimeLeftBlock:function(k,m){var l=k.status.purchaseStatus.expiresDate.getTime();var n=new Date(l);this.timers[k.asin]=GBDealNotifier.CheckoutTimer(n,true);var g={"class":"a-size-extra-large a-color-success",style:"text-align: right;"};var j={"class":"a-size-small a-color-secondary",style:"display: block; line-height: 8px;"};var h=[this.timers[k.asin].span,GBDealNotifier.DOM.span(j,[gbResources.getString("csld_remaining_part2")])];return GBDealNotifier.DOM.div(g,h)},getHeader:function(j){var k={"class":"a-box a-spacing-micro a-spacing-top-micro a-box-tab a-color-alternate-background a-text-left",style:"border-radius:0px;border:0px;border-top:1px #dddddd solid;background:white !important;padding-top:8px;"};var g={"class":"a-box-inner a-padding-mini",style:"padding-left:15px !important"};var h=[GBDealNotifier.DOM.span(g,[GBDealNotifier.DOM.text(j)])];var l=GBDealNotifier.DOM.div(k,h);return l},getHeaderString:function(l,h,k){var j=k>1?"plural":"singular";var g=this.headerStrings[l][j];if(!g){g=this.headerStrings[GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON]}return g},getAlertSprite:function(){var g=GBDealNotifier.DOM.div({style:"background-image: url("+gbResources.getImage("alerts")+");background-repeat: no-repeat;background-position: -60px -188px;height: 30px;width: 30px;float: left;margin-right: 5px;"},[]);return g},getViewCartButton:function(){var j;var h=GBDealNotifier.DOM.span({"class":"a-button a-button-primary a-button-icon"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.el("i",{"class":"a-icon a-icon-cart"}),GBDealNotifier.DOM.el("input",{"class":"a-button-input",type:"submit"}),GBDealNotifier.DOM.span({"class":"a-button-text"},[gbResources.getString("gbd_view_cart_proceed")])])]);var g="/gp/cart/view.html/ref="+this.refTagPrefix+"atc";j=this.onClickA(g,[h]);return j},expiredMessage:function(h){var g=this;var l=gbResources.getString("dn-see_current_price_avail");var k=gbResources.getString("dn-visit_detail_page");var j={"class":"a-size-small"};var m=GBDealNotifier.DOM.span(j,[GBDealNotifier.DOM.text(l+" "),g.onClickA(g.getUrl(h),[GBDealNotifier.DOM.text(k)])]);return m},getAtcButton:function(h,k,g){this.addToCartButtons[h.asin]=GBDealNotifier.DOM.div();var j=null;if(g){j=GBDealNotifier.DOM.span({"class":"a-button a-button-disabled",style:"width:95%"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.el("button",{disabled:"disabled","class":"a-button-text"},[gbResources.getString("dn_add_to_cart_button_text")])])])}else{j=GBDealNotifier.DOM.span({"class":"a-button-normal a-button-primary a-button a-button-span12"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.el("button",{"class":"a-button-text a-text-center"},[gbResources.getString("dn_add_to_cart_button_text")])])])}this.setAtcOnClick(j,h.asin);GBDealNotifier.DOM.replaceChildren(this.addToCartButtons[h.asin],[j]);return this.addToCartButtons[h.asin]},setAtcOnClick:function(h,j,k){var g=this;h.onclick=function(l){if(l){l.stopPropagation();l.preventDefault()}g.notifier.buy(j,function(){g.setErrorAtcButton(j)},k);g.showProgress(j);return false}},setErrorAtcButton:function(j){var h=gbResources.getString("dn-problem_atc");var g=gbResources.getString("dn-try_again");var k=GBDealNotifier.DOM.span({"class":"a-button a-button-beside-text a-button-primary a-button-small"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.a({"class":"a-button-text"},[g])])]);this.setAtcOnClick(k,j);if(!this.addToCartButtons[j]){return}GBDealNotifier.DOM.replaceChildren(this.addToCartButtons[j],[GBDealNotifier.DOM.span({"class":"a-size-small a-color-error a-text-bold"},[h+" "]),k])},showProgress:function(h){if(!this.addToCartButtons[h]){return}var g={"class":"a-size-small a-color-state",style:"padding-left:5px;"};GBDealNotifier.DOM.replaceChildren(this.addToCartButtons[h],[GBDealNotifier.DOM.img({alt:gbResources.getString("csld-checking_deal_status_alt"),src:gbResources.getImage("spinner")}),GBDealNotifier.DOM.span(g,[gbResources.getString("csld-checking_deal_status")])])},getContent:function(j,h){var g=this;return g.getDetailedViewAUIPopover(j,h)},getDetailedViewAUIPopover:function(q,p){var t=this;var k,o;k=GBDealNotifier.DOM.div({style:"margin-bottom: 15px;"});var r=t.asinCategoryData[q];var h={live:0,cancelled:0};if(q===GBDealNotifier.watchStateAlertEnum.WATCH_DEAL){r=t.watchDealContentUtil.dealsCategoryData[q]}else{r.sort(t.sortByAsinTimes)}if(r.length===0){return k}for(var n=0;n<r.length;n++){var m=r[n];var u=m.dealAsin;var l=m.deal;var s=null;switch(q){case GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON:s=t.getDetailedViewExpiresSoonDealTable(u,l);break;case GBDealNotifier.stateAlertsEnum.ATC_EXPIRED:s=t.getDetailedViewExpiredDealTable(u,l);break;case GBDealNotifier.stateAlertsEnum.WL_PATC:s=t.getDetailedViewWaitlistPendingATCDealTable(u,l);break;case GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED:s=t.getDetailedViewWaitListPendingATCExpiredDealTable(u,l);break;case GBDealNotifier.stateAlertsEnum.WL_SOLD_OUT:s=t.getDetailedViewWaitlistSoldOutDealTable(u,l);break;case GBDealNotifier.stateAlertsEnum.WL_DEAL_ENDED:s=t.getDetailedViewWaitlistDealEndedDealTable(u,l);break;case GBDealNotifier.watchStateAlertEnum.WATCH_DEAL:if(l.status.isValidDeal){s=t.getWatchDealLiveDealTable(l);h.live++}else{s=t.getWatchDealCancelledDealTable(l);h.cancelled++}break;default:}if(n!=r.length-1){s.style.borderBottom="1px solid rgb(228, 228, 228)"}if(s!==null){k.appendChild(s);f.each(f(s).find(".ellipsifyTitle"),function(v,w){t.watchDealContentUtil.ellipsify({el:f(w),jQuery:f})})}}if(q===GBDealNotifier.watchStateAlertEnum.WATCH_DEAL){if(!h.live){o=t.getHeaderString(GBDealNotifier.watchDealStates.WD_CANCELLED,p,h.cancelled)}else{if(!h.cancelled){o=t.getHeaderString(GBDealNotifier.watchDealStates.WD_LIVE,p,h.live)}else{var j=h.live>1?gbResources.getString("dn_deal_starting_plural"):gbResources.getString("dn_deal_starting_singular");var g=h.cancelled>1?gbResources.getString("dn_deal_cancelled_plural"):gbResources.getString("dn_deal_cancelled_singular");o=gbResources.getString("dn_watched_deal_tagline")+h.live+j+gbResources.getString("dn_and_string")+h.cancelled+g}}}else{o=t.getHeaderString(q,p,r.length)}return{content:k,header:o}},getAlertContent:function(){var j=this;var h=[GBDealNotifier.stateAlertsEnum.WL_PATC,GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON,GBDealNotifier.stateAlertsEnum.ATC_EXPIRED,GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED,GBDealNotifier.stateAlertsEnum.WL_SOLD_OUT,GBDealNotifier.stateAlertsEnum.WL_DEAL_ENDED,GBDealNotifier.watchStateAlertEnum.WATCH_DEAL];var m=[];var l=[];for(var k=0;k<h.length;k++){var g=h[k];var n=j.getContent(g);if(n.content){m.push(n.content);l.push(n.header)}}return{contentArray:m,headersArray:l}},sortByAsinTimes:function(j,h){var g=j.dealAsin.status.purchaseStatus.expiresDate;var k=h.dealAsin.status.purchaseStatus.expiresDate;return g-k},getDetailedViewImageUrl:function(g){var h=g.imageURL;h=GBDealNotifier.Utilities.checkAndSetSSLImageUrl(h);h=GBDealNotifier.resizeImage(h,100);return h},getDetailedViewTimeLeftBlock:function(p,h,o,g){var j=p.status.purchaseStatus.expiresDate.getTime();var l=new Date(j);this.timers[p.asin]=GBDealNotifier.CheckoutTimer(l,true);var n;if(g){n="00:00"}else{n=this.timers[p.asin].span}var m;if(!o){var k=g?gbResources.getString("dn_timer_span_part_2")+gbResources.getString("dn_timer_span_expired_part"):gbResources.getString("dn_timer_span_part_2");m=[GBDealNotifier.DOM.span({"class":"a-size-small a-color-base"},[gbResources.getString("dn_timer_span_part_1")]),GBDealNotifier.DOM.span({"class":"a-size-small a-text-bold"},[n]),GBDealNotifier.DOM.span({"class":"a-size-small a-color-base"},[k])]}else{m=[GBDealNotifier.DOM.span({"class":"a-size-small a-color-base"},[gbResources.getString("dn_timer_span_part_1")]),GBDealNotifier.DOM.span({"class":"a-size-small a-text-bold"},[n]),GBDealNotifier.DOM.span({"class":"a-size-small a-color-base"},[gbResources.getString("dn_claim_the_deal_string")])]}return GBDealNotifier.DOM.div({"class":"a-spacing-top-mini"},m)},getDetailedView_ViewCartButton:function(){var j=GBDealNotifier.DOM.span({"class":"a-button-normal a-button-primary a-button a-button-span12"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.el("button",{"class":"a-button-text a-text-center"},[gbResources.getString("dn_view_cart_button_text")])])]);var g="/gp/cart/view.html/ref="+this.refTagPrefix+"atc";var h=this.onClickA(g,[j]);return h},getDetailedViewExpiredMessageBlock:function(j){var h=this;var m=GBDealNotifier.DOM.span({},[gbResources.getString("dn-see_current_price_avail")]);var l=gbResources.getString("dn-visit_detail_page");var k={"class":"a-size-small",style:"padding:25px 9px 35px 9px"};var g=h.onClickA(h.getUrl(j),[GBDealNotifier.DOM.text(l)]);return GBDealNotifier.DOM.div(k,[m,GBDealNotifier.DOM.el("br",{},[]),g])},getDetailedViewExpiresSoonDealTable:function(g,h){return this.getDetailedViewDealTable(g,h)},getDetailedViewExpiredDealTable:function(h,k){var g=this;var j=GBDealNotifier.DOM.table({width:"97%",cellpadding:0,cellspacing:0,style:"margin: 10px 4px;width:97% !important;",dealID:k.dealID},[GBDealNotifier.DOM.tr({style:"vertical-align: top;"},[GBDealNotifier.DOM.td({style:"vertical-align: top;width:25%","class":"firstColumnDiv"},[g.watchDealContentUtil.getImage(g.getDetailedViewImageUrl(h),g.getUrl(h))]),GBDealNotifier.DOM.td({style:"width:75%","class":"middleColumnDiv"},[g.getDetailedViewExpiredMessageBlock(h)])])]);return j},getDetailedViewWaitlistPendingATCDealTable:function(g,h){return this.getDetailedViewDealTable(g,h,true)},getDetailedViewWaitListPendingATCExpiredDealTable:function(g,h){return this.getDetailedViewDealTable(g,h,true,true)},getDetailedViewWaitlistSoldOutDealTable:function(k,m){var g=this;var j=GBDealNotifier.DOM.span({},[gbResources.getString("dn_waitlisted_deal_sold_out_msg")]);var h=g.watchDealContentUtil.getTitleBlock(m.detail.title,g.getUrl(k));var l=GBDealNotifier.DOM.div({style:"padding:25px 9px 35px 9px;"},[j,h]);return g.getDetailedViewWaitlistCasesDealTable(k,m,l)},getDetailedViewWaitlistDealEndedDealTable:function(k,m){var g=this;var j=GBDealNotifier.DOM.span({},[gbResources.getString("dn_waitlisted_deal_ended_msg")]);var h=g.watchDealContentUtil.getTitleBlock(m.detail.title,g.getUrl(k));var l=GBDealNotifier.DOM.div({style:"padding:25px 9px 35px 9px;"},[j,h]);return g.getDetailedViewWaitlistCasesDealTable(k,m,l)},getDetailedViewWaitlistCasesDealTable:function(j,l,g){var h=this;var k=GBDealNotifier.DOM.table({width:"97%",cellpadding:0,cellspacing:0,style:"margin: 10px 4px;width:97% !important;",dealID:l.dealID},[GBDealNotifier.DOM.tr({style:"vertical-align: top;"},[GBDealNotifier.DOM.td({style:"vertical-align: top;width:25%","class":"firstColumnDiv"},[h.watchDealContentUtil.getImage(h.getDetailedViewImageUrl(j),h.getUrl(j))]),GBDealNotifier.DOM.td({style:"width:75%;","class":"middleColumnDiv"},[g])])]);return k},getDetailedViewDealTable:function(j,l,n,m){var h=this;var g=null;if(n){g=GBDealNotifier.DOM.td({style:"padding:5px"},[h.getAtcButton(j,l,m),h.getDetailedViewTimeLeftBlock(j,l,true,m)])}else{g=GBDealNotifier.DOM.td({style:"padding:5px"},[h.getDetailedView_ViewCartButton(l),h.getDetailedViewTimeLeftBlock(j,l,false,m)])}var k=GBDealNotifier.DOM.table({width:"97%",cellpadding:0,cellspacing:0,style:"margin: 10px 4px;width:97% !important;",dealID:l.dealID},[GBDealNotifier.DOM.tr({style:"vertical-align: top;"},[GBDealNotifier.DOM.td({style:"vertical-align: top;width:25%","class":"firstColumnDiv"},[h.watchDealContentUtil.getImage(h.getDetailedViewImageUrl(j),h.getUrl(j))]),GBDealNotifier.DOM.td({style:"width:43%","class":"middleColumnDiv"},[h.getMainTileDetailsBlock(l,j)]),GBDealNotifier.DOM.td({style:"width:32%;padding-right:5px;","class":"lastColumnDiv"},[g])])]);return k},getMainTileDetailsBlock:function(k,h){var g=this;var j=GBDealNotifier.DOM.div({style:"width:95%;margin-right:-300px;float:left;","class":"a-spacing-base a-fixed-right-grid-col fixedPaddingLeft a-col-right"},[g.watchDealContentUtil.getPriceBlock(k.pricingData.dealPrice),g.watchDealContentUtil.getDiscountBlock(k.pricingData.basisPrice,k.pricingData.percentOff),g.watchDealContentUtil.getTitleBlock(k.detail.title,g.getUrl(h)),k.merchantName?g.watchDealContentUtil.getSoldbyBlock(k.merchantName):"",k.reviews?g.watchDealContentUtil.getReviewStarsBlock(k.reviews.URL,k.reviews.total,k.reviews.rating):""]);return j},getWatchDealLiveDealTable:function(h){var g=this.watchDealContentUtil.getDealTableWatchDealLive(h);return g},getWatchDealCancelledDealTable:function(h){var g=this.watchDealContentUtil.getDealTableWatchDealCancelled(h);return g}});window.DealNotifier=GBDealNotifier.Class({__init__:function(k){var g=this;g.dealExpirationConnections={};g.dealExpiresSoonConnections={};if(window.navbar==null||window.navbar.getLightningDealsData==null||typeof window.navbar.getLightningDealsData!="function"){g.log("Error: navbar is not defined, cannot continue!");return}g.lightningDealsData=window.navbar.getLightningDealsData();g.asinDates={};g.cartAsins=g.getCartAsins();g.waitlistAsins={};g.warningThresholdOffset=k.thresholdOffset;g.remindersWeblab=k.remindersWeblab;g.dealRedemptionServiceWeblab=k.dealRedemptionServiceWeblab;g.sessionId=k.sessionId;g.now=parseInt(k.now,10);g.popupSkin=k.popupSkin;g.debug=k.debug||false;g.waitlistedAsins=k.waitlistedAsins;g.watchedDeals=k.watchedDeals;g.hasEverWatchedDeal=k.hasEverWatchedDeal;e=c;g.alertPopover=null;g.alertPopoverAnchor=null;g.alertPopoverContainer=null;g.seenInfo={};g.onHideData=[];g.displayingData={};if(!g.warningThresholdOffset){g.warningThresholdOffset="C"}g.active=false;g.deals={};g.asins={};g.currentAsinStates={};g.watchWaitlistedDeals={};g.displayedExpired={};g.displayedExpiresSoon={};g.displayedPendingATC={};g.displayedPendingATCExpired={};g.displayedWaitListSoldOut={};g.getDealsResponseCache={};g.asinStatesEnum={INITIALIZE:0,CHECK_SEEN:1,CALL_REGISTER_DEAL:2,DISPLAY:3};g.asinStatePriority={};g.asinStatePriority[GBDealNotifier.inCartStr]=6;g.asinStatePriority[GBDealNotifier.pendingAtcStr]=4;g.asinStatePriority[GBDealNotifier.waitInLineStr]=3;g.asinStatePriority[GBDealNotifier.expiredStr]=2;g.asinStatePriority[GBDealNotifier.availableStr]=1;g.asinStatePriority[GBDealNotifier.claimedStr]=0;g.stateStrings={};g.stateStrings[GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON]="expires_soon";g.stateStrings[GBDealNotifier.stateAlertsEnum.ATC_EXPIRED]="expired";g.stateStrings[GBDealNotifier.stateAlertsEnum.WL_PATC]="wl_patc";g.stateStrings[GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED]="wl_patc_expired";g.stateStrings[GBDealNotifier.stateAlertsEnum.WL_SOLD_OUT]="wl_sold_out";g.stateStrings[GBDealNotifier.stateAlertsEnum.WL_DEAL_ENDED]="wl_deal_ended";GBDealNotifier.Service.base_retry_interval=30000;GBDealNotifier.Service.continue_requests=true;g.service=new GBDealNotifier.Service({marketplace_id:g.getMarketplaceId()||1,customer_id:g.getCustomerId(),session_id:g.getSessionId(),timeout:10*60*1000,includeVariations:true});g.buying={};g.waitlistIntervalTimer=30000;g.waitlistInterval=null;if(!g.getCustomerId()){g.log("Customer is not recognized, shutting down.");return}var j=[];for(var h in g.cartAsins){j.push(g.cartAsins[h].ASIN)}j=j.concat(g.waitlistedAsins);g.isDeal(j,function(o){if(!o){return}var p=[];for(var l in j){var m=o.dealItems[j[l]];if(m&&m.length){var n={dealID:m[0],itemIDs:[j[l]]};p.push(n)}}g.getDeals(p,function(q){if(!q){return}g.getDealsResponseCache=g._prepareDealsInfo(q);if(g.hasLightningDeals()){g.registerAsinTimeouts()}g.registerWaitListDeals();g.log("DealNotifier instantiated.")},function(q){g.log("error calling getDeal in init method of DealNotifier "+q)})},function(l){g.log("error calling isDeal in init method of DealNotifier "+l)});g.watchDealNotifier=new window.WatchDealNotifier({dealNotifier:g});if(g.remindersWeblab==="T2"&&g.hasEverWatchedDeal){g.watchDealNotifier.registerWatchDeals(g.watchedDeals)}},registerWaitListDeals:function(){var g=this;var h=g.waitlistedAsins;var k=false;for(var j=0;j<h.length;j++){var l=h[j];g.waitlistAsins[l]={};k=true}if(k){g.getDealsForWaitlistAsins.apply(g)}},getDealsForWaitlistAsins:function(){var w=this;var h=[];for(var l in w.waitlistAsins){h.push(l)}if(h.length===0){w.log("No WaitListed ASINs, not calling GetDeals.");return}var v={};var o=w.getDealsResponseCache.deals;if(o==null){w.log("No Deals found in SelectDeals response.  Returning.");return}for(var t=0;t<o.length;t++){var r=o[t];var n=new GBDealNotifier.Model.Deal(r.dealID);n.legacyDealID=r.legacyDealID;n.load_from_deal(r);h=n.asins;if(h==null){w.log("Asins list for Deal ("+n.dealID+") is null - skipping.");continue}for(var m=0;m<h.length;m++){var k=h[m];if(w.waitlistAsins[k.asin]){if(k.status==null||k.status.purchaseStatus==null||k.status.purchaseStatus.state==null){w.log("Empty PurchaseStatus or State, skipping: "+k.asin);w.stopWatchingWaitlistAsin(k.asin);continue}var j=k.status.purchaseStatus.state;var p=GBDealNotifier.pStateTypeMap[j];if(p!=GBDealNotifier.pStateTypeEnum.WAITLIST&&p!=GBDealNotifier.pStateTypeEnum.EITHER){w.log("DealAsin isn't in a WaitList state, skipping: "+k.asin+"; pState: "+j+"; type: "+p);w.stopWatchingWaitlistAsin(k.asin);continue}v[k.asin]=1;var s=new Date(k.status.purchaseStatus.expiresDate);var g=new Date(s.getFullYear(),s.getMonth(),s.getDate());var q=Math.floor((g.getTime())/1000);w.waitlistAsins[k.asin]={dealId:n.dealID,lastUpdated:q};w.asinDates[k.asin]=q;w.cartAsins[k.asin]={ASIN:k.asin,discountExpirationDate:q};w.registerDeal.apply(w,[k.asin,n])}}}for(var u in w.waitlistAsins){if(!v[u]){w.log("GetDeals didn't return an ASIN we requested, removing it from our watch list: "+u);w.stopWatchingWaitlistAsin(u)}}w._pollStatusForWaitlistedAsins()},registerWaitlistDeal:function(j,h){var g=this;g.log("Registering waitlist deal: "+j);if(g.watchWaitlistedDeals[j]){g.log("Already watching ASIN: "+j+"; replacing with new one.");delete g.watchWaitlistedDeals[j]}g.watchWaitlistedDeals[j]=h;g.examineWaitListDeal(j,h);g._pollStatusForWaitlistedAsins()},examineWaitListDeal:function(k,j){var g=this;if(j==null||k==null){g.log("Deal or ASIN is null, returning.");return}var h=GBDealNotifier.findDealAsin(k,j);if(h==null){g.log("No DealAsin found, returning.");return}g.getNotificationInfo(k,g.cartAsins[k].discountExpirationDate,function(l){var n=null;var m=h.status.purchaseStatus.state;g.registerSeenInfo(k,l.seen);if(m===GBDealNotifier.pendingAtcStr){n=GBDealNotifier.stateAlertsEnum.WL_PATC;if(h.status.purchaseStatus.msToExpiry<=0){n=GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED}}else{if(m===GBDealNotifier.expiredStr){n=GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED}else{if(m===GBDealNotifier.waitInLineStr){if(parseInt(h.status.percentSoldOut,10)>=100||parseInt(h.status.offerServiceSoldOut)){n=GBDealNotifier.stateAlertsEnum.WL_SOLD_OUT}else{return}}else{g.stopWatchingWaitlistAsin(k);return}}}var o=g.getStateString(n);var p=g.seenInfo[k][o];if(p==true){g.log("Customer has already seen an alert for: "+k+"; state: "+o+". Not showing alert.");return}if(m===GBDealNotifier.pendingAtcStr){j.connect("pstatus_expire",function(q,r){g.handleStateExpiration(q,r,GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED);g.stopWatchingWaitlistAsin(r)})}g.displayAlert(k,n)},function(l){g.log("Error getting Wait List info: "+l)})},refreshWatchedDealView:function(h,g){self.watchDealContentUtil.refreshWatchedDealView(h,g)},_pollStatusForWaitlistedAsins:function(){var g=this;if(!g.getCustomerId()){g.log("DealNotifier cannot activate without a CustomerID.");return}if(!g.getSessionId()){g.log("DealNotifier cannot activate without a SessionID.");return}if(!g.waitlistInterval){g.waitlistInterval=window.setInterval(function(){g.updateWaitlistDeals.apply(g)},g.waitlistIntervalTimer)}g.log("DealNotifier activated.")},_stopPollingForWaitlistedAsins:function(){var g=this;if(g.waitlistInterval){g.waitlistInterval=window.clearInterval(g.waitlistInterval)}g.log("DealNotifier deactivated.")},updateWaitlistDeals:function(){var h=this;h.log("Checking for Deals to Update");var g=h._getDealIdsFromWaitlistAsins();if(g.length===0){h.log("No more Wait Listed ASINs, shutting down.");h._stopPollingForWaitlistedAsins();return}h.getDealAsinStatuses(function(j){var o=j.dealAsinStatuses;for(var k=0;k<o.length;k++){var n=o[k];var l=n.dealID;var m=n.asin;if(h.waitlistAsins[m]!=null&&h.waitlistAsins[m].dealId==l){h.watchWaitlistedDeals[m].load_from_asin_status(n);h.examineWaitListDeal(m,h.watchWaitlistedDeals[m])}else{h.log("Not a Waitlist ASIN: "+m)}}},function(j){h.log("GetDealAsinStatus: FAILURE: "+j)})},registerAsinTimeouts:function(){var h=this;for(var k in h.cartAsins){var g=h.cartAsins[k];var j=parseInt(g.discountExpirationDate,10);h.registerAsin(k,j)}},registerAsin:function(l,j){var p=this;p.currentAsinStates[l]=p.asinStatesEnum.INITIALIZE;var k=p.getDealAsinStatusObj(l);var n=null;if(k&&k.purchaseStatus){var g=k.purchaseStatus.msToExpiry;var h=new Date();var o=(h.getTime()-h.getMilliseconds())/1000;n=(g/1000)+o;n=Math.floor(n)}var m=p.getTimeUntilWarn(n,p.now);p.log("TimeLapse: "+m);window.setTimeout(function(){var q=p.nextFunction(l);q.apply(p,[l])},m*1000);p.log("ASIN Registered: "+l)},nextFunction:function(m){var h=this;var j={};j[h.asinStatesEnum.INITIALIZE]=h.asinStatesEnum.CHECK_SEEN;j[h.asinStatesEnum.CHECK_SEEN]=h.asinStatesEnum.CALL_REGISTER_DEAL;j[h.asinStatesEnum.CALL_REGISTER_DEAL]=h.asinStatesEnum.DISPLAY;j[h.asinStatesEnum.DISPLAY]=null;var k=h.currentAsinStates[m];var l=j[k];h.currentAsinStates[m]=l;var g=null;switch(h.currentAsinStates[m]){case h.asinStatesEnum.INITIALIZE:g=function(){};break;case h.asinStatesEnum.CHECK_SEEN:g=h.checkIfSeen;break;case h.asinStatesEnum.CALL_REGISTER_DEAL:g=h.callRegisterDeal;break;case h.asinStatesEnum.DISPLAY:g=h.displayAlert;break;default:g=function(){}}return g},checkIfSeen:function(k){var j=this;j.log("Checking if Customer has seen Alert for ASIN: "+k);var h=j.cartAsins[k];var g=h.discountExpirationDate;j.getNotificationInfo(k,g,function(l){if(l.seen.expired!=true){j.registerSeenInfo(k,l.seen);var m=j.nextFunction(k);m.call(j,k)}},function(l){j.log("Error getting asin state info: "+l)})},callRegisterDeal:function(o){var h=this;var m=h.getDealsResponseCache.deals;if(m==null){h.log("No Deals found in SelectDeals response.  Returning.");return}for(var k=0;k<m.length;k++){var l=m[k];var n=new GBDealNotifier.Model.Deal(l.dealID);n.legacyDealID=l.legacyDealID;n.purchaseStatusWarningThreshold=h.getWarningThreshold();n.load_from_deal(l);if(n.asins==null){return}for(var g=0;g<n.asins.length;g++){var j=n.asins[g];if(j.asin!=o){h.log("ASINs don't match for DealID: "+l.dealID+": "+j.asin+" != "+o+"(original) (SKIPPING)");continue}if(j.status.purchaseStatus.state==="InCart"||j.status.purchaseStatus.state==="Expired"){h.registerDeal(o,n);return}else{h.log("Deal status is not 'InCart': "+j.status.purchaseStatus.state)}}}},displayAlert:function(l,j){var g=this;var k=g.watchWaitlistedDeals[l];var h=k.dealID;g.getDealStatus([{dealID:h,itemIDs:[l]}],function(m){if(m.dealAsinStatuses[0].purchaseStatus.state===GBDealNotifier.claimedStr){return}else{if(k==null){g.log("ERROR, displayAlert was called for an ASIN with no Deal! ASIN: "+l);return}var n=g.getDisplayed(l,j);if(n!=true){g.addOnHideData(l,j);g.createOrAddAlert(l,k,j)}else{g.log("Already displayed Alert for: "+k.dealID+"; "+l)}g.setDisplayed(l,j)}},function(m){g.log("getDealStatus: FAILURE: "+m)})},insertDisplayingData:function(k,j,h){var g=this;if(k==null||j==null||h==null){g.log("Error inserting DisplayingData, asin, deal, or stateAlertEnum is null.");return}g.displayingData[k]={deal:j,stateAlertEnum:h}},getDisplayingData:function(){return this.displayingData},getDisplayed:function(k,j){var g=this;var h=false;switch(j){case GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON:h=(g.displayedExpiresSoon[k]==1);break;case GBDealNotifier.stateAlertsEnum.ATC_EXPIRED:h=(g.displayedExpired[k]==1);break;case GBDealNotifier.stateAlertsEnum.WL_PATC:h=(g.displayedPendingATC[k]==1);break;case GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED:h=(g.displayedPendingATCExpired[k]==1);break;case GBDealNotifier.stateAlertsEnum.WL_SOLD_OUT:h=(g.displayedWaitListSoldOut[k]==1);break;default:}return h},setDisplayed:function(j,h){var g=this;switch(h){case GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON:g.displayedExpiresSoon[j]=1;break;case GBDealNotifier.stateAlertsEnum.ATC_EXPIRED:g.displayedExpired[j]=1;break;case GBDealNotifier.stateAlertsEnum.WL_PATC:g.displayedPendingATC[j]=1;break;case GBDealNotifier.stateAlertsEnum.WL_PATC_EXPIRED:g.displayedPendingATCExpired[j]=1;break;case GBDealNotifier.stateAlertsEnum.WL_SOLD_OUT:g.displayedWaitListSoldOut[j]=1;break;default:}},createOrAddAlert:function(k,j,h){var g=this;g.log("Called createOrAddAlert for: "+k+"; "+j.dealID);g.insertDisplayingData(k,j,h);g.createGenericAlert()},createGenericAlert:function(){var h=this;var k=h.getPopupContent();var j=k.content;var m=k.header;var l=null;if(h.alertPopover){b.remove(h.alertPopover);h.alertPopover=null}if(!h.alertPopoverAnchor){h.alertPopoverAnchor=GBDealNotifier.DOM.div({id:"gb_deal_notifier_anchor",style:"position:fixed;top:10px;right:50px;height:1px;width:1px;"});f("body").append(h.alertPopoverAnchor)}var g=f("#gb_deal_notifier_anchor");h.alertPopover=b.create(g,{content:j,header:m,position:"triggerBottom",activate:"onclick",width:500,name:"DealNotifierPopover"});f(h.alertPopover.inlineContent).css({maxHeight:f(window).height()-100});c.on("a:popover:dismiss:DealNotifierPopover",function(){if(h.alertPopover){h.handleOnHide.apply(h,[])}});c.on("a:popover:show:DealNotifierPopover",function(n){var o=parseInt(n.popover.$popover.css("z-index"));if(c.isFiniteNumber(o)&&o<=210){n.popover.$popover.css("z-index",o+210)}n.popover.$popover.find(".a-arrow-border").hide()});h.alertPopover.lock();g.trigger("click");if(h.alertPopover){f(window).resize(function(){h.handleWindowResize()});f(window).scroll(function(){h.handleWindowResize()})}},handleWindowResize:function(){var g=this;if(g.alertPopover){if(e){g.alertPopover.updatePosition();return}g.alertPopover.css("left",f(window).scrollLeft()+f(window).width()-g.alertPopover.outerWidth()-10);if(f.browser.msie){g.alertPopover.css("top",f(window).scrollTop()+10)}else{g.alertPopover.css("top",10)}}},handleOnHide:function(j,m){var q=this;if(!m){for(var o=0;o<q.onHideData.length;o++){var n=q.onHideData[o];var l=n.asin;var k=n.discountExpirationDate;var h=n.stateAlertEnum;if(j!=undefined&&l!=j){continue}q.setNotificationInfo.apply(q,[l,k,h])}}if(q.remindersWeblab==="T2"&&q.watchDealNotifier){var g="";if(!j&&!m){for(var p in q.watchDealNotifier.watchDealDisplayingData){g+=p+","}q.watchDealNotifier.callModifyWatchedDeals("clearValue")}else{if(j&&m){g=j+","}}if(g){g=g.substr(0,g.length-1);q.watchDealNotifier.updateWatchedDealSeenInfo({action:"setSeen",dealIDs:g})}q.watchDealNotifier.watchDealDisplayingData={};q.watchDealNotifier.updateWatchedDeals={}}q.alertPopover.hide();q.onHideData=[];q.displayingData={};q.alertPopover=null;q.alertPopoverContainer=null;q.alertPopoverAnchor=null},getPopupContent:function(){var q=this;var g=q.watchDealNotifier?q.watchDealNotifier.watchDealDisplayingData:null;var k=new d({displayingData:q.displayingData,notifier:q,onClickFunction:function(r){q.handleOnHide.apply(q,[r])},watchDealDisplayingData:g});var m=k.getAlertContent();var o=m.contentArray;var j=m.headersArray;var n=gbResources.getString("dn-deal-notifications");var p=GBDealNotifier.DOM.div({"class":"lightningDealAlertBox",width:"100%",style:"margin:-18px;"});for(var l=0;l<o.length;l++){var h=o[l];f(h).prepend(k.getHeader(j[l]));p.appendChild(h)}return{content:p,header:n}},registerCartDeal:function(j,h){var g=this;h.purchaseStatusWarningThreshold=g.getWarningThreshold();if(!g.seenInfo[j]||!g.seenInfo[j].expired){g.dealExpirationConnections[j]=h.connect("pstatus_expire",function(l,k){g.handleStateExpiration(l,k,GBDealNotifier.stateAlertsEnum.ATC_EXPIRED)})}if(!g.seenInfo[j]||!g.seenInfo[j].expires_soon){g.dealExpiresSoonConnections[j]=h.connect("pstatus_expires_soon",function(l,k){g.handleStateExpiration(l,k,GBDealNotifier.stateAlertsEnum.ATC_EXPIRES_SOON)})}},registerDeal:function(n,o){var t=this;if(!t.getCustomerId()){t.log("Error: Cannot register a deal if the customer is not recognized.");return}if(!t.getSessionId()){t.log("Error: Cannot register a deal if the customer has no SessionID.")}if(n==null||o==null){t.log("Error: registerDeal(): Must provide both an asin and a Deal object.");return}var u=GBDealNotifier.findDealAsin(n,o);if(u==null){t.log("Error: couldn't find corresponding DealAsin for Deal: "+o.dealID+"; ASIN: "+n);return}o.pricingData=o.pricingData||{};var h=u.dealPrice;var g=u.basisPrice;if(h===null||g===null){return}o.pricingData.dealPrice=h instanceof Object?GBDealNotifier.Utilities.getFormattedPrice(h.price,h.currency):h;o.pricingData.basisPrice=g instanceof Object?GBDealNotifier.Utilities.getFormattedPrice(g.price,g.currency):g;o.pricingData.percentOff=u.percentOff;if(u.status==null){t.log("Error: DealAsinStatus is null for Deal: "+o.dealID+"; ASIN: "+n);return}var s=u.status.purchaseStatus.state;if(!s){t.log("Error: PurchaseState is null for Deal: "+o.dealID+"; ASIN: "+n);return}if(s===GBDealNotifier.availableStr||s===GBDealNotifier.claimedStr){t.log("Purchase state is Available or Claimed.  Ignoring.");return}var p=GBDealNotifier.pStateTypeMap[s];var j=null;if(!t.watchWaitlistedDeals[n]){j=t.getRegisterFunction(u);if(j!=null){t.setDealAndDateData(n,o);j.apply(t,[n,o])}}else{var k=t.watchWaitlistedDeals[n];var r=GBDealNotifier.findDealAsin(n,k);var m=r.status.purchaseStatus.state;var q=t.asinStatePriority[m];var l=t.asinStatePriority[s];if(q==null||l==null){t.log("Error: Priorities for deal are null.");return}if(q>=l){t.log("Incoming DealAsinPurchaseState has a lower priority than the current one, ignoring: Deal: "+o.dealID+"; ASIN: "+n);return}if(t.waitlistAsins[n]){t.stopWatchingWaitlistAsin(n)}else{t.stopWatchingCartAsin(n)}delete t.watchWaitlistedDeals[n];j=t.getRegisterFunction(u);if(j!=null){t.setDealAndDateData(n,o);j.apply(t,[n,o])}}t.log("Registered DealID "+o.dealID+" for: ASIN "+n)},disconnectAll:function(){var g=this;for(var h in g.dealExpirationConnections){g.dealExpirationConnections[h].disconnect()}for(var h in g.dealExpirationConnections){g.dealExpiresSoonConnections[h].disconnect()}g.dealExpirationConnections={};g.dealExpiresSoonConnections={}},handleStateExpiration:function(m,o,k){var h=GBDealNotifier.findDealAsin(o,m);var g=this;if(!g.watchWaitlistedDeals[h.asin]){g.log("handleStateExpire ("+h.asin+"): Not watching ASIN - IGNORING.");return}else{g.log("handleStateExpire ("+h.asin+"): Watching ASIN - CONTINUE.")}var n=g.getSeenAlertForState(h.asin,k);var l=g.getDisplayed(h.asin,k);if(n==true||l==true){g.log("Already seen alert for ("+h.asin+", "+k+") - ignoring");return}else{g.log("Haven't seen alert, continuing")}var j=g.cartAsins[h.asin].discountExpirationDate;g.getNotificationInfo(h.asin,j,function(p){g.registerSeenInfo(h.asin,p.seen);var q=g.getSeenAlertForState(h.asin,k);if(q==false){g.getStatusAndDisplayAlert(h.asin,k)}},function(p){g.seenInfo[h.asin]={expires_soon:false,expired:false};g.displayAlert(h.asin,k)})},getStatusAndDisplayAlert:function(j,h){var g=this;g.getDealAsinStatus(j,function(k){var l=k.dealAsinStatuses;if(l==null||l.length==0){g.log("Error, dealAsinStatuses is null or empty. Not displaying alert.");return}var o=null;for(var m=0;m<l.length;m++){var n=l[m];if(n!=null&&n.asin==j){o=n;break}}if(o==null){g.log("Couldn't find DealAsinStatus for "+j+"; not displaying alert.");return}g.displayAlert(j,h)},function(k){g.log("Error calling GetDealAsinStatus: "+k)})},getSeenAlertForState:function(k,h){var g=this;if(!g.seenInfo[k]){g.log("no info, returning null");return null}var j=g.stateStrings[h];if(j==null){return false}var l=g.seenInfo[k][j];if(l==null){return false}return l},getDealAsinStatus:function(l,n,j){var h=this;if(l==null){h.log("Asin is null, can't call GetDealAsinStatus.");return}var k=h.watchWaitlistedDeals[l];if(k&&k.dealID){var g=[{dealID:k.dealID,itemIDs:[l]}];h.getDealStatus(g,n,j)}else{var m=[l];h.selectDeals(m,n,j)}},getDealAsinStatuses:function(m,h){var g=this;var n=[];for(var l in g.waitlistAsins){if(g.waitlistAsins[l]&&g.waitlistAsins[l].dealId){var j=g.waitlistAsins[l].dealId;var k={dealID:j,itemIDs:[l]};n.push(k)}}g.log("Calling GetDealAsinStatuses: "+n);g.getDealStatus(n,m,h)},_getDealIdsFromWaitlistAsins:function(){var h=this;var g=[];for(var j in h.waitlistAsins){if(h.waitlistAsins[j]&&h.waitlistAsins[j].dealId){g.push(h.waitlistAsins[j].dealId)}}return g},getTimeUntilWarn:function(j,h){var k=j-h;var g=k-(this.getWarningThreshold()/1000);if(g<0){g=0}return g},hasLightningDeals:function(){var h=this.getCartAsins();for(var g in h){if(g!=null){return true}}return false},isDeal:function(k,j,h){var g=this;if(!k||k.length===0){g.log("no asins specified while calling isDeal for DealNotifer. returning");return}g.service.call("/xa/dealcontent/v2/IsDeal",{requestMetadata:{marketplaceID:g.getMarketplaceId(),clientID:"goldbox_notifier"},itemIDs:k,dealTypes:["LIGHTNING_DEAL"],dealStates:["AVAILABLE","WAITLIST","WAITLISTFULL","EXPIRED","SOLDOUT"]},function(l){j(l)},function(l){h(l)})},getDeals:function(k,j,h){var g=this;if(!k||k.length===0){g.log("no deal target is specified while calling GetDeals in DealNotifier. returning");return}g.service.call("/xa/dealcontent/v2/GetDeals",{requestMetadata:{marketplaceID:g.getMarketplaceId(),customerID:g.getCustomerId(),sessionID:g.getSessionId(),clientID:"goldbox_notifier"},dealTargets:k},function(l){j(l)},function(l){h(l)})},getDealStatus:function(k,j,h){var g=this;if(!k||k.length===0){g.log("no deal target is specified while calling GetDealStatus in DealNotifier. returning");return}g.service.call("/xa/dealcontent/v2/GetDealStatus",{requestMetadata:{marketplaceID:g.getMarketplaceId(),customerID:g.getCustomerId(),sessionID:g.getSessionId(),clientID:"goldbox_notifier"},responseSize:"STATUS_ONLY",itemResponseSize:"NONE",page:1,dealsPerPage:k.length,dealTargets:k,queryProfile:{dealTypes:["LIGHTNING_DEAL"]}},function(l){l=g.prepareDealAsinStatuses(l);j(l)},function(l){h(l)})},prepareDealAsinStatuses:function(k){var p=this;if(!k){return}var m=[];var l=k.dealStatus;for(var n in l){var g=l[n].dealItemStatus;if(g){for(var j in g){var o=g[j];if(o){var h=p._itemStatusToAsinStatus(o,j,n);m.push(h)}}}}return{dealAsinStatuses:m}},_prepareDealsInfo:function(h){var v=this;var k=[];var p=[];var m=h.dealStatus;var n=h.dealDetails;for(var r in n){var q=n[r];var l=[];var j={};j.customer={};var o=n[r].items;if(o){for(i=0;i<o.length;i++){var u=o[i];var w={status:{}};w.asin=u.itemID;w.dealID=r;w.imageURL=u.primaryImage;w.dealPrice=GBDealNotifier.Utilities.getFormattedPrice(u.dealPrice,u.currencyCode);w.basisPrice=GBDealNotifier.Utilities.getFormattedPrice(u.bAmount,u.currencyCode);w.percentOff=u.percentOff?GBDealNotifier.Utilities.getDisplayablePercentOff(u.percentOff):"";if(u.variationDimensions){w.variationData={};for(var t in u.variationDimensions){w.variationData[t]=u.variationDimensions[t]}}if(m[r]&&m[r].dealItemStatus&&m[r].dealItemStatus[u.itemID]){var s=m[u.dealID].dealItemStatus[u.itemID];if(GBDealNotifier.customerStates[s.customerState]==GBDealNotifier.claimedStr){w.isCustomerClaimed=true}else{w.isCustomerClaimed=false}var g=v._itemStatusToAsinStatus(s,u.itemID,r);w.status=g;p.push(g)}l.push(w)}}j.asins=l;j.dealID=r;j.legacyDealID=q.legacyDealID;j.marketplaceID=gbResources.getCustomerData("realm");j.detail={title:q.title,buyBoxUrl:q.ingressUrl};j.merchantName=q.merchantName;j.reviews={};GBDealNotifier.Utilities._loadReviewsFromServiceResponse(j,q);k.push(j)}return{deals:k,dealAsinStatuses:p}},_itemStatusToAsinStatus:function(g,l,j){var h=this;var k={};if(g){k.purchaseStatus={};k.purchaseStatus.waitListStatus={};k.asin=l;k.dealID=j;k.percentClaimed=g.percentClaimed;if(g.itemState==="SOLDOUT"){k.percentSoldOut=100;k.offerServiceSoldOut=true}if(g.itemState==="WAITLISTFULL"){k.currentlyUnavailable=true}else{k.currentlyUnavailable=false}k.purchaseStatus.lastUpdated=g.lastUpdated;k.purchaseStatus.msToExpiry=g.msToCustomerStateExpiry;k.purchaseStatus.msToCacheExpires=g.msCacheTtl;k.purchaseStatus.state=GBDealNotifier.customerStates[g.customerState];if(g.waitlistPosition){k.purchaseStatus.waitListStatus.position=g.waitlistPosition;k.purchaseStatus.waitListStatus.inCartIndicator=g.waitlistChance}}return k},getWarningThreshold:function(){var h=this;var j=2*60*1000;var g=j;if(h.warningThresholdOffset!="C"){g=parseInt(h.warningThresholdOffset,10)*60*1000}return g},getCartAsins:function(){var g=this;var l=g.lightningDealsData.activeItems;var k={};if(l==null||l==undefined){return k}for(var h=0;h<l.length;h++){var j=l[h];k[j.ASIN]=j;g.asinDates[j.ASIN]=j.discountExpirationDate}return k},addOnHideData:function(k,j){var h=this;var g=h.cartAsins[k];if(g==null||g.discountExpirationDate==null){h.log("Error adding onHideData: no cart data for ASIN: "+k);return}h.onHideData.push({asin:k,stateAlertEnum:j,discountExpirationDate:g.discountExpirationDate})},getCustomerId:function(){return this.lightningDealsData.customerID},getSessionId:function(){return this.sessionId},getMarketplaceId:function(){return this.lightningDealsData.marketplaceID},getNoCacheValue:function(){return new Date().getTime()},getNotificationInfo:function(l,k,n,h){var g=this;var j="/gp/deal/ajax/getSeen.html?customerID="+g.getCustomerId()+"&sessionID="+g.getSessionId()+"&asin="+l+"&dealExpirationDate="+k+"&nocache="+g.getNoCacheValue();var m={success:function(o){n(o)},error:function(o){h(o)},failure:function(o){h(o)},url:j,type:"POST",data:"{}",dataType:"json"};f.ajax(m)},setNotificationInfo:function(m,k,j){var g=this;var l=null;if(g.stateStrings[j]){l=g.stateStrings[j]}else{g.log("Invalid eStateAlert: '"+j+"' - cannot set notification info.");return}l=g.stateStrings[j];g.log("Setting notification info for: ("+m+", "+k+", "+j+" ("+l+"))");var h="/gp/deal/ajax/setSeen.html?customerID="+g.getCustomerId()+"&sessionID="+g.getSessionId()+"&asin="+m+"&dealExpirationDate="+k+"&state="+l+"&nocache="+g.getNoCacheValue();var n={success:function(o){if(o.success){g.log("Successfully setSeen for asin: "+o.request.asin+"; "+o.request.ded)}else{g.log("Error calling setSeen for asin: "+o.request.asin+"; "+o.request.ded)}},error:function(o){g.log("Error calling setSeen: "+o)},failure:function(o){g.log("Failure calling setSeen: "+o)},url:h,type:"POST",data:"{}",dataType:"json"};f.ajax(n)},buy:function(n,h,m){var g=this;if(!g.service.customer_id){g.log("Error: Can't call buy if the customer is unrecognized!");return}var l,k;if(m){l=g.watchDealNotifier.updateWatchedDeals[n];k=l.detail.buyAsin}else{l=g.watchWaitlistedDeals[n];k=n}if(l==null){g.log("Error: Can't call buy, no Deal found for ASIN: "+k);return}var j=l.dealID;if(!g.buying[j]){g.buying[j]=true;if(g.dealRedemptionServiceWeblab==="T1"){g.buyCallingDRS(l,k,n,m,h)}else{g.buyCallingDealService(l,k,n,m,h)}}},buyCallingDRS:function(l,k,g,m,j){var h=this;h.isWatchedDeal=m;h.asinOrDealId=g;h.service.claim_deal(l.dealID,k,function(p){var n=GBDealNotifier.responseCustomerStates.NONE;if(p!==undefined&&p!==null){var o=p.dealItemStatus;if(o!==undefined&&o!==null){n=o.customerState}}if(n===GBDealNotifier.responseCustomerStates.INCART){if(h.isWatchedDeal){h.handleOnHide(h.asinOrDealId,h.isWatchedDeal)}else{h.handleOnHide(k)}window.location="/gp/cart/view.html/ref=xs_gb_ld_tck_"+l.dealID}else{if(n===GBDealNotifier.responseCustomerStates.INWAITLIST){h.handleOnHide(h.asinOrDealId,h.isWatchedDeal)}else{j()}}delete h.isWatchedDeal;delete h.asinOrDealId},function(n){h.log("Error calling ClaimDeal: "+n);j()})},buyCallingDealService:function(l,k,g,m,j){var h=this;h.isWatchedDeal=m;h.asinOrDealId=g;h.service.redeem_deal(l.legacyDealID,k,function(n){if(n.redeemed==1){var p=n.deal;var r=p.asins;var q;var s;for(var o=0;o<r.length;o++){s=r[o];if(s.asin==k){q=s;break}}if(s&&s.status.purchaseStatus.state===GBDealNotifier.inCartStr){if(h.isWatchedDeal){h.handleOnHide(h.asinOrDealId,h.isWatchedDeal)}else{h.handleOnHide(s)}window.location="/gp/cart/view.html/ref=xs_gb_ld_tck_"+l.dealID}else{if(s&&s.status.purchaseStatus.state===GBDealNotifier.waitInLineStr){h.handleOnHide(h.asinOrDealId,h.isWatchedDeal)}else{j()}}delete h.isWatchedDeal;delete h.asinOrDealId}else{j()}},function(n){h.log("Error caling RedeemDeal: "+n);j()})},calculatePurchaseStateEpoch:function(m,l){var p=this;var h=0;var q=GBDealNotifier.findDealAsin(l,m);if(q.status&&q.status.purchaseStatus){var j=q.status.purchaseStatus.msToExpiry;var k=new Date();var o=(k.getTime()-k.getMilliseconds())/1000;h=(j/1000)+o;h=Math.floor(h);var n=new Date(h*1000);var g=new Date(n.getFullYear(),n.getMonth(),n.getDate());h=Math.floor((g.getTime())/1000);p.log("Setting purchaseStateEpoch to: "+h)}return h},registerSeenInfo:function(j,h){this.seenInfo[j]={};for(var g in h){this.seenInfo[j][g]=h[g]}},setDealAndDateData:function(m,l){var h=this;h.watchWaitlistedDeals[m]=l;var j=GBDealNotifier.findDealAsin(m,l);var g=h.getPurchaseStateType(j);if(!h.cartAsins[m]||g==GBDealNotifier.pStateTypeEnum.WAITLIST){h.log("Deal was sent from a widget, overriding CartData: "+l.dealID+"; "+m);var k=h.calculatePurchaseStateEpoch(l,m);h.setDateData(m,l,k)}},setDateData:function(m,l,k){var h=this;h.cartAsins[m]={ASIN:m,discountExpirationDate:k};h.asinDates[m]=k;var j=GBDealNotifier.findDealAsin(m,l);var g=h.getPurchaseStateType(j);if(g==GBDealNotifier.pStateTypeEnum.WAITLIST){k=j.status.purchaseStatus.lastUpdated;h.log("Adding Asin to WaitList watch list: "+m);h.waitlistAsins[m]={dealId:l.dealID,lastUpdated:k}}},getPurchaseStateType:function(j){var g=null;if(j&&j.status&&j.status.purchaseStatus){var h=j.status.purchaseStatus.state;g=GBDealNotifier.pStateTypeMap[h]}return g},getRegisterFunction:function(j){var h=this;var g=j.status.purchaseStatus.state;var l=GBDealNotifier.pStateTypeMap[g];var k=null;switch(l){case GBDealNotifier.pStateTypeEnum.CART:h.log("Cart Deal: "+j.asin);k=h.registerCartDeal;break;case GBDealNotifier.pStateTypeEnum.WAITLIST:h.log("WaitList Deal: "+j.asin);k=h.registerWaitlistDeal;break;case GBDealNotifier.pStateTypeEnum.EITHER:h.log("Cart Deal: "+j.asin);k=h.registerCartDeal;break;default:h.log("Invalid State for DealAsin"+j.asin)}return k},stopWatchingWaitlistAsin:function(g){this.log("Removing Wait List ASIN from watch list: "+g);delete this.waitlistAsins[g]},stopWatchingCartAsin:function(h){var g=this;g.log("Removing Cart ASIN from watch list: "+h);if(g.dealExpirationConnections[h]){g.dealExpirationConnections[h].disconnect();delete g.dealExpirationConnections[h]}if(g.dealExpiresSoonConnections[h]){g.dealExpiresSoonConnections[h].disconnect();delete g.dealExpiresSoonConnections[h]}},getStateString:function(g){return this.stateStrings[g]},log:function(g){if(this.debug){GBDealNotifier.log(g)}},getDealAsinStatusObj:function(j){var g=this;if(g.getDealsResponseCache){var k=g.getDealsResponseCache.dealAsinStatuses;if(k.length){for(var h=0;h<k.length;h++){if(k[h].asin===j){return k[h]}}}}return null}});var a=GBDealNotifier.Class({__init__:function(h){var g=this;g.watchDealDisplayingData=h.watchDealDisplayingData;g.dealContentUtil=h.dealContentUtil;g.dealsCategoryData={};for(var j in GBDealNotifier.watchStateAlertEnum){g.dealsCategoryData[GBDealNotifier.watchStateAlertEnum[j]]=[]}if(g.watchDealDisplayingData){g.categorizeDeals()}},categorizeDeals:function(){var h=this;for(var j in h.watchDealDisplayingData){var k=h.watchDealDisplayingData[j];var l=k.deal;var g=k.watchDealState;if(h.dealsCategoryData[g]){h.dealsCategoryData[g].push({deal:l})}else{continue}}},getDealTableWatchDealCancelled:function(j){var g=this;var h=GBDealNotifier.DOM.table({width:"97%",cellpadding:0,cellspacing:0,style:"margin: 10px 4px;width:97% !important;",dealID:j.dealID},[GBDealNotifier.DOM.tr({style:"vertical-align: top;"},[GBDealNotifier.DOM.td({style:"vertical-align: top;width:25%","class":"firstColumnDiv"},[g.getImage(j.detail.imageAsin,j.detail.URL)]),GBDealNotifier.DOM.td({style:"width:75%","class":"middleColumnDiv"},[g.getCancelledTitleBlock(j.detail.title,j.detail.URL)])])]);return h},getCancelledTitleBlock:function(l,k){var g=this;var j=GBDealNotifier.DOM.span({},[gbResources.getString("dn_watched_deal_cancelled_msg")]);var h=g.getTitleBlock(l,k);return GBDealNotifier.DOM.div({style:"padding:25px 9px 35px 9px;"},[j,h])},getDealTableWatchDealLive:function(n,k){var h=this;var g=null;var j="a-color-base";switch(n.status.dealState){case GBDealNotifier.dealStates.AVAILABLE:g=h.getAtcButton(n);break;case n.status.dealState===GBDealNotifier.dealStates.SOLDOUT:g=GBDealNotifier.DOM.td({style:"padding-top:2px"},[h.getSoldOutBlock(n)]);j="a-color-tertiary";break;case GBDealNotifier.dealStates.EXPIRED:g=GBDealNotifier.DOM.td({style:"padding-top:2px"},[h.getExpiredBlock(n)]);j="a-color-tertiary";break;case GBDealNotifier.dealStates.WAITLIST:g=h.getJoinWaitlistButton(n);break;case GBDealNotifier.dealStates.WAITLISTFULL:g=GBDealNotifier.DOM.td({style:"padding-top:2px"},[h.getWaitListFullBlock(n)]);j="a-color-tertiary";break}if(n.detail.itemType==="VARIATION_ITEM"){g=h.getSeeDetailsButton(n)}if(k){var m=f(".lightningDealAlertBox").find("table[dealID = "+n.dealID+" ]");m.remove()}var l=GBDealNotifier.DOM.table({width:"97%",cellpadding:0,cellspacing:0,style:"margin: 10px 4px;width:97% !important;",dealID:n.dealID},[GBDealNotifier.DOM.tr({style:"vertical-align: top;"},[GBDealNotifier.DOM.td({style:"vertical-align: top;width:25%","class":"firstColumnDiv"},[h.getImage(n.detail.imageAsin,n.detail.URL)]),GBDealNotifier.DOM.td({style:"width:43%","class":"middleColumnDiv"},[h.getMainTileDetailsBlock(n,j)]),GBDealNotifier.DOM.td({style:"width:32%;padding: 0px 12px;","class":"lastColumnDiv"},[g])])]);return l},refreshWatchedDealView:function(h,g){self.getDealTableWatchDealLive(h,g)},getMainTileDetailsBlock:function(m,j){if(!j){j="a-color-base"}var g=this;var k=m.pricingData.prices.dealPrice?m.pricingData.prices.dealPrice.min.formattedValue:"";var h=m.pricingData.prices.basisPrice?m.pricingData.prices.basisPrice.min.formattedValue:"";var l=GBDealNotifier.DOM.div({style:"width:95%;margin-right:-300px;float:left;","class":"a-spacing-base a-fixed-right-grid-col fixedPaddingLeft a-col-right"},[g.getPriceBlock(k,j),g.getDiscountBlock(h,m.pricingData.percentOff,j),g.getClaimedProgressBarBlock(m.status.percentClaimed,j),g.getClaimedTextBlock(m.status.percentClaimed,m.status.msToEnd,j),g.getTitleBlock(m.detail.title,m.detail.URL,j),g.getSoldbyBlock(m.merchantName,j),g.getReviewStarsBlock(m.reviews.URL,m.reviews.total,m.reviews.rating)]);return l},getPriceBlock:function(j,h){if(!h){h="a-color-base"}var g=GBDealNotifier.DOM.div({"class":"a-row unitLineHeight a-spacing-mini "+h},[GBDealNotifier.DOM.span({"class":"a-color-small heading4 inlineBlock unitLineHeight",style:""},[j])]);return g},getDiscountBlock:function(g,j,h){if(!h){h="a-color-base"}if(gbResources.getCustomerData("realm")==="CN"){return""}var k=GBDealNotifier.DOM.div({"class":"a-row unitLineHeight a-spacing-mini "+h},[GBDealNotifier.DOM.span({"class":"a-size-mini inlineBlock unitLineHeight"},["List: "]),GBDealNotifier.DOM.span({"class":"a-size-mini inlineBlock unitLineHeight a-text-strike"},[g]),GBDealNotifier.DOM.span({"class":"a-size-mini inlineBlock unitLineHeight"},[" ("+j+"% Off)"])]);return k},getClaimedProgressBarBlock:function(j,h){if(!h){h="a-color-base"}var g=h==="a-color-tertiary"?"grey":"#E77600";var k=GBDealNotifier.DOM.div({"class":"a-row"},[GBDealNotifier.DOM.div({"class":"a-row progbarWrapper",style:"position:relative;height:4px;background-color:#DDDDDD;font-size:1px;"},[GBDealNotifier.DOM.div({"class":"progbar",style:"width:"+j+"%;height:4px;position:absolute;background-color:"+g+";font-size:1px;"})])]);return k},getClaimedTextBlock:function(k,g){var h=new Date();h.setMilliseconds(h.getMilliseconds()+g);var j=GBDealNotifier.DOM.div({"class":"a-row unitLineHeight"},[GBDealNotifier.DOM.div({"class":"a-column a-span6"},[GBDealNotifier.DOM.span({"class":"a-size-mini a-color-secondary inlineBlock unitLineHeight percentClaimedSpan"},[k+"% claimed"])]),GBDealNotifier.DOM.div({"class":"a-column a-span6 a-text-right unitLineHeight a-span-last"},[GBDealNotifier.DOM.div({"class":"a-row"},[GBDealNotifier.DOM.span({"class":"a-size-mini a-color-secondary inlineBlock unitLineHeight"},["Ends in"]),GBDealNotifier.DOM.span({"class":"a-size-mini a-color-secondary inlineBlock unitLineHeight"},[" "]),GBDealNotifier.DOM.span({"class":"a-size-mini a-color-secondary inlineBlock unitLineHeight"},[GBDealNotifier.Timer(h).span])])])]);return j},getTitleBlock:function(l,j,h){if(!h){h="a-color-base"}var k;if(h==="a-color-tertiary"){k=GBDealNotifier.DOM.a({style:"max-height:34px;overflow:hidden;width:auto;color:#0066c0 !important","class":"a-size-base a-link-normal titleLineHeight ellipsifyTitle "+h},[l])}else{k=GBDealNotifier.DOM.a({href:j,style:"max-height:34px;overflow:hidden;width:auto;color:#0066c0 !important","class":"a-size-base a-link-normal titleLineHeight ellipsifyTitle "+h},[l])}var g=GBDealNotifier.DOM.div({"class":"a-row unitLineHeight a-spacing-top-mini a-spacing-mini "+h,style:"max-height:34px;overflow:hidden;color:#0066c0"},[GBDealNotifier.DOM.div({"class":"a-row  inlineBlock unitLineHeight"},[k])]);return g},getSoldbyBlock:function(j,g){if(!g){g="a-color-base"}var h=GBDealNotifier.DOM.div({"class":"a-row a-spacing-mini "},[GBDealNotifier.DOM.div({"class":"a-row unitLineHeight"},[GBDealNotifier.DOM.span({"class":"a-size-mini a-color-base inlineBlock unitLineHeight"+g},[gbResources.getString("dn_sold_by_string")+j])])]);return h},getReviewStarsBlock:function(h,l,k){var g=Math.floor(k);var j=k-g;if(j>0.7){k=++g}else{if(j>=0.3){k=g+"-5"}else{k=g}}var m=GBDealNotifier.DOM.div({"class":"a-row unitLineHeight"},[GBDealNotifier.DOM.div({"class":"a-row reviewStars"},[GBDealNotifier.DOM.a({href:h,"class":"a-link-normal touchAnchor"},[GBDealNotifier.DOM.el("i",{"class":"a-icon a-icon-star a-star-"+k}),l])])]);return m},getImage:function(h,g){var j=this;var l=h;l=GBDealNotifier.resizeImage(l,100);var m=GBDealNotifier.DOM.img({src:l,border:0});var n=j.onClickA(g,m);var k=GBDealNotifier.DOM.div({style:"width:85%;height:85%;vertical-align:middle;text-align:center;padding:5%;"},[n]);return k},getAtcButton:function(l,g){var h=this;var k=null;if(g){k=GBDealNotifier.DOM.span({"class":"a-button a-button-disabled"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.el("button",{disabled:"disabled","class":"a-button-text"},[gbResources.getString("dn_add_to_cart_button_text")])])])}else{k=GBDealNotifier.DOM.span({"class":"a-button-normal a-button-primary a-button a-button-span12"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.el("button",{"class":"a-button-text a-text-center"},[gbResources.getString("dn_add_to_cart_button_text")])])])}var j=l.dealID;h.dealContentUtil.setAtcOnClick(k,j,true);return k},getJoinWaitlistButton:function(k){var g=this;var h=GBDealNotifier.DOM.span({"class":"a-button-normal a-button-primary a-button a-button-span12"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.el("button",{"class":"a-button-text a-text-center"},[gbResources.getString("dn_join_waitlist_button_text")])])]);var j=k.dealID;g.dealContentUtil.setAtcOnClick(h,j,true);return h},getSeeDetailsButton:function(k){var h=GBDealNotifier.DOM.span({"class":"a-button-normal a-button-primary a-button a-button-span12"},[GBDealNotifier.DOM.span({"class":"a-button-inner"},[GBDealNotifier.DOM.el("button",{"class":"a-button-text a-text-center"},[gbResources.getString("dn_see_details_button_text")])])]);var g=k.detail.egressUrl;var j=this.onClickA(g,[h]);return j},getWaitListFullBlock:function(h){var g=GBDealNotifier.DOM.span({},[gbResources.getString("dn_waitlist_full_string")]);return g},getSoldOutBlock:function(h){var g=GBDealNotifier.DOM.span({},[gbResources.getString("dn_sold_out_string")]);return g},getExpiredBlock:function(h){var g=GBDealNotifier.DOM.span({},[gbResources.getString("dn_expired_string")]);return g},onClickA:function(h,j){var g=this;var k=GBDealNotifier.DOM.a({href:h},[j]);f(k).click(function(){if(g.onClickFunction){g.onClickFunction()}f(window.location).attr("href",h);return false});return k},ellipsify:function(l){var j=l.el;var m=l.jQuery;var o=l.wordsIntact;var q=l.removeDots;var g=j.clone().empty().css({display:"none",height:"auto"}).width(j.width());j.width(j.width());m(j).after(g);var r=m.trim(j.html());g.html(r);if(g.height()<=j.height()){m(g).remove();return}g.empty();var p=0,h=0,k=r.length;while(p<r.length&&h<k){p=Math.floor((h+k)/2);if(q){g.html(r.substr(0,p))}else{g.html(r.substr(0,p)+"...")}if(g.height()<=j.height()){h=p+1}else{k=p-1}}r=r.substr(0,h-1);if(o){var n=r.lastIndexOf(" ");r=r.substr(0,n)}if(!q){r=r+"..."}j.html(r);m(g).remove()}});window.WatchDealNotifier=GBDealNotifier.Class({__init__:function(h){var g=this;g.dealNotifier=h.dealNotifier;g.allWatchedDeals={};g.dealsSeenInfo={};g.updateWatchedDeals={};g.displayedWatched={};g.watchDealDisplayingData={};g.watchDealsIntervalTimer=10000;g.watchDealsInterval=null},_activatePollingWatched:function(){var g=this;if(!g.dealNotifier.getCustomerId()){g.dealNotifier.log("WatchDealNotifier cannot activate without a CustomerID");return}if(!g.dealNotifier.getSessionId()){g.dealNotifier.log("WatchDealNotifier cannot activate without a SessionID");return}if(!g.watchDealsInterval){g.watchDealsInterval=window.setInterval(function(){g.callModifyWatchedDeals.apply(g,["getValue"])},g.watchDealsIntervalTimer)}g.dealNotifier.log("WatchDealNotifier activated")},_deactivatePollingWatched:function(){var g=this;if(g.watchDealsInterval){g.watchDealsInterval=window.clearInterval(g.watchDealsInterval)}g.dealNotifier.log("WatchDealNotifier deactivated")},registerWatchDeals:function(h){var g=this;var j=g._makeDealIdsString(h);g._registerFilteredWatchedDeals(j)},_makeDealIdsString:function(j){var h=this;var m="";var g=j;var n=g.length;for(var k=0;k<n;k++){var l=g[k];if(!h.allWatchedDeals[l]){m+=l+","}}m=m===""?"":m.substr(0,m.length-1);return m},_registerFilteredWatchedDeals:function(h){var g=this;if(h){g.updateWatchedDealSeenInfo({action:"getSeen",dealIDs:h},function(t){var l=t.value;var k=[];for(var p in l){var q=parseInt(l[p]);g.dealsSeenInfo[p]=q;if(!q){k.push({dealID:p})}}var n=GBDealNotifier.GD_BATCH_SIZE;var s=k.length%n;s=s?s:n;var o=Math.ceil(k.length/n);for(var m=0;m<o;m++){var j;var r=n*m;if(m===o-1){j=k.slice(r,r+s)}else{j=k.slice(r,r+n)}g.dealNotifier.getDeals(j,function(u){g._registerWatchDealObjects(u)},function(u){g.dealNotifier.log("getDeal Status call fails "+u)})}},function(j){})}if(!g.watchDealsInterval){g._activatePollingWatched()}},updateWatchedDealSeenInfo:function(h,k,l){var j={success:function(m){if(k){k(m)}},error:function(m){},params:{action:h.action,dealIDs:h.dealIDs},dataType:"json"};var g="/gp/deal/ajax/modifyDealSeenInfo.html";f.post(g,j.params,j.success,j.dataType)},_registerWatchDealObjects:function(k){var p=this;for(var m in k.dealDetails){var j=k.dealStatus[m];var l=k.dealDetails[m];var n=j.dealState;if(n===GBDealNotifier.dealStates.EXPIRED||n===GBDealNotifier.dealStates.SOLDOUT||n===GBDealNotifier.dealStates.WAITLISTFULL){p.allWatchedDeals[m]=n;continue}if((n===GBDealNotifier.dealStates.UPCOMING||n===GBDealNotifier.dealStates.COMINGSOON)&&j.isValid){continue}var g=j.dealItemStatus&&j.dealItemStatus[l.reviewAsin];var o;if(g){o=g.customerState}if(o&&(o===GBDealNotifier.responseCustomerStates.INCART||o===GBDealNotifier.responseCustomerStates.CLAIMED||o===GBDealNotifier.responseCustomerStates.PENDINGATC||o===GBDealNotifier.responseCustomerStates.INWAITLIST||o===GBDealNotifier.responseCustomerStates.EXPIRED)){p.allWatchedDeals[m]=o;continue}var h=new GBDealNotifier.Model.WatchDeal(m);h._loadDetailsFromServiceResponse(l);h._loadStatusFromServiceResponse(j);h._updateTeaserDetails(l);h.customerData.marketplaceID=p.dealNotifier.getMarketplaceId();h.customerData.customerID=p.dealNotifier.getCustomerId();h.customerData.dealID=m;p._renderWatchedDeal(h);if(h.status.isValidDeal){p.updateWatchedDeals[m]=h;p.allWatchedDeals[m]="live"}else{p.allWatchedDeals[m]="cancelled"}}},_renderWatchedDeal:function(j){var g=this;var h=g._ifDealDisplayed(j.dealID);if(!h){g._insertDealDisplayingData(j);g.dealNotifier.createGenericAlert()}g._setDealDisplayed(j.dealID)},_insertDealDisplayingData:function(h){var g=this;var j={deal:h,watchDealState:GBDealNotifier.watchStateAlertEnum.WATCH_DEAL};g.watchDealDisplayingData[h.dealID]=j},_ifDealDisplayed:function(h){var g=this;var j=false;j=g.displayedWatched[h];return j},_setDealDisplayed:function(h){var g=this;g.displayedWatched[h]=true},_refreshWatchedDealNotifier:function(j,h){var g=this;g.dealNotifier.refreshWatchedDealView(j,h)},callModifyWatchedDeals:function(j){var g=this;var k={success:function(l){g._updateWatchedDeals(l)},args:{action:j}};var h="/gp/goldbox/ajax/getWatchedDeals.html";f.post(h,k.args,k.success)},_updateWatchedDeals:function(g){var h=this;h.dealNotifier.log("Checking for watched deals to update");var k=g;var l=h._makeDealIdsString(k.value);if(l){h._registerFilteredWatchedDeals(l)}var m=[];for(var j in h.updateWatchedDeals){m.push({dealID:j})}h.dealNotifier.getDealStatus(m,function(n){var p=n.dealStatus;for(var t in p){var r=p[t].dealState;var s=h.updateWatchedDeals[t].status.dealState;var o=p[t].percentClaimed;var q=h.updateWatchedDeals[t].status.percentClaimed;if(r!=s||o!=q){h.updateWatchedDeals[t].status.dealState=r;h.updateWatchedDeals[t].status.percentClaimed=o;h._refreshWatchedDealNotifier(h.updateWatchedDeals[t],true)}else{return}}},function(n){})}});if(window.P&&window.P.AUI_BUILD_DATE){window.gbRegistered=window.gbRegistered||{};if(!window.gbRegistered.lightningDealNotifier){window.gbRegistered.lightningDealNotifier=true;P.register("lightningDealNotifier",function(){return window.DealNotifier})}}};if(window.P&&window.P.AUI_BUILD_DATE){P.when("A","a-popover","gbDealNotifierScope").execute(function(b,a){registerDealNotifierUtil(b.$,b,a)})};
if(typeof(amznJQ)==='object'){amznJQ.declareAvailable('deal_notifier');}if(typeof(P)==='object'){window.gbRegistered=window.gbRegistered||{};if(!window.gbRegistered.deal_notifier){window.gbRegistered.deal_notifier=true;P.register('deal_notifier');}}